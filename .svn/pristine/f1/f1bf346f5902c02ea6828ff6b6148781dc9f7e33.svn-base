<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.train.mapper.CertificateMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.train.po.Certificate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="up_score" jdbcType="INTEGER" property="up_score" />
    <result column="down_score" jdbcType="INTEGER" property="down_score" />
    <result column="cert_name" jdbcType="VARCHAR" property="cert_name" />
    <result column="source_id" jdbcType="BIGINT" property="source_id" />
    <result column="source_type" jdbcType="INTEGER" property="source_type" />
    <result column="is_every" jdbcType="INTEGER" property="is_every" />
    <result column="cert_model_id" jdbcType="BIGINT" property="cert_model_id" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    id, up_score, down_score, cert_name, source_id, source_type, is_every, cert_model_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from certificate
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    delete from certificate
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.train.po.Certificate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into certificate (up_score, down_score, cert_name, 
      source_id, source_type, 
      is_every, cert_model_id)
    values (#{up_score,jdbcType=INTEGER}, #{down_score,jdbcType=INTEGER}, #{cert_name,jdbcType=VARCHAR}, 
      #{source_id,jdbcType=BIGINT}, #{source_type,jdbcType=INTEGER},
      #{is_every,jdbcType=INTEGER},#{cert_model_id,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.Certificate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into certificate
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="up_score != null">
        up_score,
      </if>
      <if test="down_score != null">
        down_score,
      </if>
      <if test="cert_name != null">
        cert_name,
      </if>
      <if test="source_id != null">
        source_id,
      </if>
      <if test="source_type != null">
        source_type,
      </if>
      <if test="is_every != null">
        is_every,
      </if>
      <if test="cert_model_id != null">
        cert_model_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="up_score != null">
        #{up_score,jdbcType=INTEGER},
      </if>
      <if test="down_score != null">
        #{down_score,jdbcType=INTEGER},
      </if>
      <if test="cert_name != null">
        #{cert_name,jdbcType=VARCHAR},
      </if>
      <if test="source_id != null">
        #{source_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null">
        #{source_type,jdbcType=INTEGER},
      </if>
      <if test="is_every != null">
        #{is_every,jdbcType=INTEGER},
      </if>
      <if test="cert_model_id != null">
        #{cert_model_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.Certificate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    update certificate
    <set>
      <if test="up_score != null">
        up_score = #{up_score,jdbcType=INTEGER},
      </if>
      <if test="down_score != null">
        down_score = #{down_score,jdbcType=INTEGER},
      </if>
      <if test="cert_name != null">
        cert_name = #{cert_name,jdbcType=VARCHAR},
      </if>
      <if test="source_id != null">
        source_id = #{source_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null">
        source_type = #{source_type,jdbcType=INTEGER},
      </if>
      <if test="is_every != null">
        is_every = #{is_every,jdbcType=INTEGER},
      </if>
      <if test="cert_model_id != null">
        cert_model_id = #{cert_model_id,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.train.po.Certificate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    update certificate
    set up_score = #{up_score,jdbcType=INTEGER},
      down_score = #{down_score,jdbcType=INTEGER},
      cert_name = #{cert_name,jdbcType=VARCHAR},
      source_id = #{source_id,jdbcType=BIGINT},
      source_type = #{source_type,jdbcType=INTEGER},
      is_every = #{is_every,jdbcType=INTEGER},
      cert_model_id = #{cert_model_id,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="findAll" parameterType="cn.bnsr.edu_yun.frontstage.train.view.CertificatesView" resultType="cn.bnsr.edu_yun.frontstage.train.view.CertificatesView">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    SELECT 
    c.id AS certificate_id,c.up_score,c.down_score,c.cert_name,
    c.source_id,c.source_type,c.is_every,c.cert_model_id,cm.title AS cert_model_title
    FROM certificate c 
    LEFT JOIN cert_model cm ON c.cert_model_id = cm.id
    WHERE c.source_id = #{source_id,jdbcType=BIGINT}
    AND c.source_type = #{source_type,jdbcType=INTEGER}
    ORDER BY c.down_score desc
  </select>
  
   <select id="findMyCourseCert" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView">
    SELECT us.id, co.title AS course_name,c.classes,us.complete_time,
	SUM(CASE WHEN ch.attribute_type IN (0,4) THEN (SELECT MAX(e.exam_score) FROM exam e WHERE e.test_paper_id=t.id AND e.user_id=us.user_id)*ces.ratio/100 
	 WHEN ch.attribute_type=3 THEN ch.frequency ELSE 0 END) AS score,ce.cert_name
	FROM user_study us 
	LEFT JOIN user_cert uc ON uc.user_study_id=us.id 
	LEFT JOIN certificate ce ON ce.id=uc.cert_id 
	LEFT JOIN class c ON us.source_id=c.id
	LEFT JOIN course co ON co.id=us.learn_id  
	LEFT JOIN course_hour ch ON co.id=ch.course_id
	LEFT JOIN course_exam_standard ces ON ces.source_id=ch.id
	LEFT JOIN test_paper t ON t.course_hour_id=ch.id
	WHERE us.user_id=${user_id} AND us.is_studyed=1 AND us.source_type=${source_type} 
	GROUP BY us.id 
	ORDER BY us.complete_time DESC
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="countUserCertificate" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="java.lang.Integer">
    SELECT COUNT(*)
	FROM user_study us 
	WHERE us.user_id=${user_id} AND us.is_studyed=1 AND us.source_type=${source_type} 
  </select>
  
  <select id="findMyTrainCert" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView">
    SELECT us.id AS user_study_id,us.user_id,t.name AS course_name,c.classes,us.complete_time,
    us.learn_id AS train_id,t.type,tes.required_ratio,tes.option_ratio,ce.cert_name
	FROM user_study us 
	LEFT JOIN user_cert uc ON uc.user_study_id=us.id 
	LEFT JOIN certificate ce ON ce.id=uc.cert_id 
	LEFT JOIN class c ON us.source_id=c.id
	LEFT JOIN train t ON t.id=us.learn_id
    LEFT JOIN train_exam_standard tes ON tes.train_id=t.id
	WHERE us.source_type=${source_type} AND us.user_id=${user_id} AND us.is_studyed=1
	ORDER BY us.complete_time DESC
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="queryCommonTrainCourseId" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="java.lang.Long">
    SELECT course_id
	FROM train_course  
	WHERE source_id=${train_id} AND source_type=0
	<if test="is_required != null">
	AND is_required=${is_required} 
	</if>
  </select>
  
  <select id="queryMyCourseScore" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="java.lang.Integer">
    SELECT SUM(CASE WHEN ch.attribute_type IN (0,4) THEN (SELECT MAX(e.exam_score) FROM exam e WHERE e.test_paper_id=t.id AND e.user_id=${user_id} )*ces.ratio/100 
	WHEN ch.attribute_type=3 THEN ch.frequency ELSE 0 END) AS score
	FROM course_hour ch 
	LEFT JOIN course_exam_standard ces ON ces.source_id=ch.id
	LEFT JOIN test_paper tp ON tp.course_hour_id=ch.id
	WHERE ch.course_id=${course_id}
  </select>
  
  <select id="queryPhaseTrainCourseId" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="java.lang.Long">
    SELECT tc.course_id
	FROM train_phase tp
	LEFT JOIN train_course tc ON tc.source_id=tp.id
	WHERE tp.train_id=${train_id} AND tc.source_type=1 
	<if test="is_required != null">
	AND tc.is_required=${is_required}
	</if>
  </select>
  
  <select id="findMyCert" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView">
    SELECT uc.study_name AS course_name,uc.score,uc.complete_time,uc.cert_id,c.cert_name,uc.user_id
	FROM user_cert uc 
	LEFT JOIN certificate c ON c.id=uc.cert_id
	WHERE uc.user_id=${user_id} AND uc.study_type=${source_type}
	ORDER BY uc.complete_time DESC
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="countMyCert" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserCertificateView" resultType="java.lang.Integer">
    SELECT COUNT(*)
	FROM user_cert uc 
	LEFT JOIN certificate c ON c.id=uc.cert_id
	WHERE uc.user_id=${user_id} AND uc.study_type=${source_type}
  </select>
  
</mapper>