<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.train.mapper.UserTrainClassMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="source_id" jdbcType="BIGINT" property="source_id" />
    <result column="user_id" jdbcType="BIGINT" property="user_id" />
    <result column="class_id" jdbcType="BIGINT" property="class_id" />
    <result column="is_studyed" jdbcType="INTEGER" property="is_studyed" />
    <result column="course_id" jdbcType="BIGINT" property="course_id" />
    <result column="source_type" jdbcType="INTEGER" property="source_type" />
    <result column="user_study_id" jdbcType="BIGINT" property="user_study_id" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    id, source_id, user_id, class_id, is_studyed, course_id, source_type, user_study_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from user_train_class
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    delete from user_train_class
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user_train_class (source_id, user_id, class_id, 
      is_studyed, course_id)
    values (#{source_id,jdbcType=BIGINT}, #{user_id,jdbcType=BIGINT}, #{class_id,jdbcType=BIGINT}, 
      #{is_studyed,jdbcType=INTEGER}, #{course_id,jdbcType=BIGINT}, #{source_type,jdbcType=INTEGER},
      #{user_study_id,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user_train_class
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="source_id != null">
        source_id,
      </if>
      <if test="user_id != null">
        user_id,
      </if>
      <if test="class_id != null">
        class_id,
      </if>
      <if test="is_studyed != null">
        is_studyed,
      </if>
      <if test="course_id != null">
        course_id,
      </if>
      <if test="source_type != null">
        source_type,
      </if>
      <if test="user_study_id != null">
        user_study_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="source_id != null">
        #{source_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null">
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="class_id != null">
        #{class_id,jdbcType=BIGINT},
      </if>
      <if test="is_studyed != null">
        #{is_studyed,jdbcType=INTEGER},
      </if>
      <if test="course_id != null">
        #{course_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null">
        #{source_type,jdbcType=INTEGER},
      </if>
      <if test="user_study_id != null">
        #{user_study_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    update user_train_class
    <set>
      <if test="source_id != null">
        source_id = #{source_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null">
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="class_id != null">
        class_id = #{class_id,jdbcType=BIGINT},
      </if>
      <if test="is_studyed != null">
        is_studyed = #{is_studyed,jdbcType=INTEGER},
      </if>
      <if test="course_id != null">
        course_id = #{course_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null">
        source_type = #{source_type,jdbcType=INTEGER},
      </if>
      <if test="user_study_id != null">
        user_study_id = #{user_study_id,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 09 15:48:42 CST 2017.
    -->
    update user_train_class
    set source_id = #{source_id,jdbcType=BIGINT},
      user_id = #{user_id,jdbcType=BIGINT},
      class_id = #{class_id,jdbcType=BIGINT},
      is_studyed = #{is_studyed,jdbcType=INTEGER},
      course_id = #{course_id,jdbcType=BIGINT},
      source_type = #{source_type,jdbcType=INTEGER},
      user_study_id = #{user_study_id,jdbcType=BIGINT},
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="searchCourseClassId" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserStudyView" resultType="cn.bnsr.edu_yun.frontstage.train.po.UserStudy">
  	SELECT class_id as source_id
  	FROM user_train_class
  	WHERE  1=1
  	<if test="userId != null" >
        AND user_id = #{userId}
    </if>
    <if test="learnId != null" >
        AND course_id = #{learnId}
    </if>
    <if test="trainType != null" >
        AND source_type = #{trainType}
    </if>
  </select>
  
  <select id="queryTrainCourse" resultType="cn.bnsr.edu_yun.frontstage.train.view.CourseView">
  	SELECT t.source_id as phaseId, c.id, c.title,c.hours
	FROM user_train_class t
	LEFT JOIN course c ON t.course_id = c.id
	WHERE t.source_id = #{sourceId}
	AND t.user_id = #{userId}
	AND t.course_id in
		<foreach collection="list" item="list"  open="(" separator="," close=")">  
        	#{list}  
     	</foreach> 
	AND t.source_type = 1
  </select>
  
  <select id="searchIsStudy" parameterType="cn.bnsr.edu_yun.frontstage.train.view.TrainCourseView" resultType="cn.bnsr.edu_yun.frontstage.train.view.TrainCourseView">
	SELECT t.is_studyed,t.course_id
	FROM user_train_class t
	WHERE t.source_id = #{source_id}
	AND t.source_type = ${source_type}
	AND t.user_id = ${userId}
	<if test="source_type == 0 and  course_id != null" >
		AND t.course_id = ${course_id}
	</if>
	<if test="source_type == 1 " >
		AND t.course_id in
		<foreach collection="list" item="list"  open="(" separator="," close=")">  
        	#{list}  
     	</foreach> 
	</if>
  </select>
  
  <select id="searchTrainClassStudent" resultType="cn.bnsr.edu_yun.frontstage.train.view.UserStudyView">
  	SELECT u.icon, u.username as studentName, u.id as userId, u.realname as realName, 
		ui.profile, p.attent_count as attentNum, p.is_attented_count as fansNum
  	FROM user_train_class s 
  	LEFT JOIN user u ON  u.id = s.user_id
  	LEFT JOIN user_info ui ON  ui.user_id = s.user_id
  	LEFT JOIN user_property p ON p.id = u.property_id
  	WHERE s.class_id = ${classId}
  	  	 <if test="trainType != null" >
        AND s.source_type = #{trainType}
    </if>
  </select>

<select id="queryUserTrainClass" resultType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
  	SELECT s.*
  	FROM user_train_class s 
  	WHERE s.class_id = ${class_id}
  	and s.user_id=${user_id}
  	and s.course_id=${course_id}
  	and s.user_study_id=${user_study_id}
  </select>
   <select id="selectCountByCourseIdAndUserId"  resultType="java.lang.Integer" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    SELECT COUNT(*)  FROM user_train_class  utc
     <if test="train_required!= null" >
     LEFT JOIN train_course tc on tc.source_id=utc.source_id and tc.course_id=utc.course_id
     </if>
    WHERE  1=1
    AND utc.user_id=#{user_id,jdbcType=BIGINT}
    AND utc.user_study_id=#{user_study_id,jdbcType=BIGINT}
    <if test="train_required!= null" >
    AND tc.is_required=${train_required}
    </if>
  </select>
  
   <select id="selectCountByCourseIdAndUserIdStudy"  resultType="java.lang.Integer" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
    SELECT COUNT(*)  FROM user_train_class utc
    <if test="train_required!= null" >
     LEFT JOIN train_course tc on tc.source_id=utc.source_id and tc.course_id=utc.course_id
     </if>
    WHERE  utc.is_studyed=1
    AND utc.user_id=#{user_id,jdbcType=BIGINT} 
    AND utc.user_study_id=#{user_study_id,jdbcType=BIGINT}
     <if test="train_required!= null" >
    AND tc.is_required=${train_required}
    </if>
  </select>
  <select id="queryUserTrainCourse" resultType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass">
  	SELECT s.*
  	FROM user_train_class s 
  	WHERE s.class_id = ${class_id}
  	and s.user_id=${user_id}
  	and s.user_study_id=${user_study_id}
  </select>
  
  <select id="queryUserTrainCourseCount" resultType="cn.bnsr.edu_yun.frontstage.train.view.UserTrainClassView" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserTrainClassView">
  	SELECT utc.is_studyed,count(utc.course_id) as course_total,sum(c.hours) as hours_total 
  	FROM user_train_class utc
  	INNER JOIN course c
  	ON utc.source_id=${source_id} 
  	AND utc.source_type=${source_type}
  	AND utc.user_id=${user_id} 
  	AND utc.class_id=${class_id} 
  	AND utc.course_id=c.id
  	GROUP BY utc.is_studyed
  </select>
  
  <select id="queryUnfinish"  parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserTrainClass" resultType="cn.bnsr.edu_yun.frontstage.base.po.User">
  	SELECT u.id,u.username FROM user_train_class utc
	LEFT JOIN USER u ON u.id=utc.user_id
 	WHERE utc.source_id=${source_id}
	and utc.course_id=${course_id}
	and utc.is_studyed=0
 	GROUP BY u.id
  </select> 
</mapper>