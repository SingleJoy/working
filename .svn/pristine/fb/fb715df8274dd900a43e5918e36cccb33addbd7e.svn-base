<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.tiku.mapper.QuestionMapper" >
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="difficulty" property="difficulty" jdbcType="INTEGER" />
    <result column="belong_to" property="belong_to" jdbcType="BIGINT" />
    <result column="belong_type" property="belong_type" jdbcType="INTEGER" />
    <result column="classify_id" property="classify_id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="update_time" property="update_time" jdbcType="TIMESTAMP" />
    <result column="create_time" property="create_time" jdbcType="TIMESTAMP" />
    <result column="is_son" property="is_son" jdbcType="INTEGER" />
    <result column="type" property="type" jdbcType="INTEGER" />
    <result column="score" property="score" jdbcType="DOUBLE" />
    <result column="is_item" property="is_item" jdbcType="INTEGER" />
    <result column="right_key" property="right_key" jdbcType="VARCHAR" />
    <result column="course_id" property="course_id" jdbcType="BIGINT" />
   </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="cn.bnsr.edu_yun.frontstage.tiku.po.Question" extends="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <result column="stem" property="stem" jdbcType="LONGVARCHAR" />
    <result column="analysis" property="analysis" jdbcType="LONGVARCHAR" />
    <result column="option_a" property="option_a" jdbcType="LONGVARCHAR" />
    <result column="option_b" property="option_b" jdbcType="LONGVARCHAR" />
    <result column="option_c" property="option_c" jdbcType="LONGVARCHAR" />
    <result column="option_d" property="option_d" jdbcType="LONGVARCHAR" />
    <result column="option_e" property="option_e" jdbcType="LONGVARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    id, difficulty, belong_to, belong_type, classify_id, user_id, update_time, create_time, 
    is_son, type, score, is_item, right_key,course_id
  </sql>
  <sql id="Blob_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    stem, analysis, option_a, option_b, option_c, option_d, option_e
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from question
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    delete from question
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into question (difficulty, belong_to, belong_type, 
      classify_id, user_id, update_time, 
      create_time, is_son, type, 
      score, is_item, right_key, 
      stem, analysis, option_a, 
      option_b, option_c, option_d, 
      option_e,course_id)
    values (#{difficulty,jdbcType=INTEGER}, #{belong_to,jdbcType=BIGINT}, #{belong_type,jdbcType=INTEGER}, 
      #{classify_id,jdbcType=BIGINT}, #{user_id,jdbcType=BIGINT}, #{update_time,jdbcType=TIMESTAMP}, 
      #{create_time,jdbcType=TIMESTAMP}, #{is_son,jdbcType=INTEGER}, #{type,jdbcType=INTEGER}, 
      #{score,jdbcType=DOUBLE}, #{is_item,jdbcType=INTEGER}, #{right_key,jdbcType=VARCHAR}, 
      #{stem,jdbcType=LONGVARCHAR}, #{analysis,jdbcType=LONGVARCHAR}, #{option_a,jdbcType=LONGVARCHAR}, 
      #{option_b,jdbcType=LONGVARCHAR}, #{option_c,jdbcType=LONGVARCHAR}, #{option_d,jdbcType=LONGVARCHAR}, 
      #{option_e,jdbcType=LONGVARCHAR}, #{course_id,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into question
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="difficulty != null" >
        difficulty,
      </if>
      <if test="belong_to != null" >
        belong_to,
      </if>
      <if test="belong_type != null" >
        belong_type,
      </if>
      <if test="classify_id != null" >
        classify_id,
      </if>
      <if test="user_id != null" >
        user_id,
      </if>
      <if test="update_time != null" >
        update_time,
      </if>
      <if test="create_time != null" >
        create_time,
      </if>
      <if test="is_son != null" >
        is_son,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="score != null" >
        score,
      </if>
      <if test="is_item != null" >
        is_item,
      </if>
      <if test="right_key != null" >
        right_key,
      </if>
      <if test="stem != null" >
        stem,
      </if>
      <if test="analysis != null" >
        analysis,
      </if>
      <if test="option_a != null" >
        option_a,
      </if>
      <if test="option_b != null" >
        option_b,
      </if>
      <if test="option_c != null" >
        option_c,
      </if>
      <if test="option_d != null" >
        option_d,
      </if>
      <if test="option_e != null" >
        option_e,
      </if>
      <if test="course_id != null" >
          course_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="difficulty != null" >
        #{difficulty,jdbcType=INTEGER},
      </if>
      <if test="belong_to != null" >
        #{belong_to,jdbcType=BIGINT},
      </if>
      <if test="belong_type != null" >
        #{belong_type,jdbcType=INTEGER},
      </if>
      <if test="classify_id != null" >
        #{classify_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null" >
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="update_time != null" >
        #{update_time,jdbcType=TIMESTAMP},
      </if>
      <if test="create_time != null" >
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_son != null" >
        #{is_son,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        #{type,jdbcType=INTEGER},
      </if>
      <if test="score != null" >
        #{score,jdbcType=DOUBLE},
      </if>
      <if test="is_item != null" >
        #{is_item,jdbcType=INTEGER},
      </if>
      <if test="right_key != null" >
        #{right_key,jdbcType=VARCHAR},
      </if>
      <if test="stem != null" >
        #{stem,jdbcType=LONGVARCHAR},
      </if>
      <if test="analysis != null" >
        #{analysis,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_a != null" >
        #{option_a,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_b != null" >
        #{option_b,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_c != null" >
        #{option_c,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_d != null" >
        #{option_d,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_e != null" >
        #{option_e,jdbcType=LONGVARCHAR},
      </if>
      <if test="course_id != null" >
        #{course_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    update question
    <set >
      <if test="difficulty != null" >
        difficulty = #{difficulty,jdbcType=INTEGER},
      </if>
      <if test="belong_to != null" >
        belong_to = #{belong_to,jdbcType=BIGINT},
      </if>
      <if test="belong_type != null" >
        belong_type = #{belong_type,jdbcType=INTEGER},
      </if>
      <if test="classify_id != null" >
        classify_id = #{classify_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null" >
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="update_time != null" >
        update_time = #{update_time,jdbcType=TIMESTAMP},
      </if>
      <if test="create_time != null" >
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_son != null" >
        is_son = #{is_son,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="score != null" >
        score = #{score,jdbcType=DOUBLE},
      </if>
      <if test="is_item != null" >
        is_item = #{is_item,jdbcType=INTEGER},
      </if>
      <if test="right_key != null" >
        right_key = #{right_key,jdbcType=VARCHAR},
      </if>
      <if test="stem != null" >
        stem = #{stem,jdbcType=LONGVARCHAR},
      </if>
      <if test="analysis != null" >
        analysis = #{analysis,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_a != null" >
        option_a = #{option_a,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_b != null" >
        option_b = #{option_b,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_c != null" >
        option_c = #{option_c,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_d != null" >
        option_d = #{option_d,jdbcType=LONGVARCHAR},
      </if>
      <if test="option_e != null" >
        option_e = #{option_e,jdbcType=LONGVARCHAR},
      </if>
      <if test="course_id != null" >
        course_id = #{course_id,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    update question
    set difficulty = #{difficulty,jdbcType=INTEGER},
      belong_to = #{belong_to,jdbcType=BIGINT},
      belong_type = #{belong_type,jdbcType=INTEGER},
      classify_id = #{classify_id,jdbcType=BIGINT},
      user_id = #{user_id,jdbcType=BIGINT},
      update_time = #{update_time,jdbcType=TIMESTAMP},
      create_time = #{create_time,jdbcType=TIMESTAMP},
      is_son = #{is_son,jdbcType=INTEGER},
      type = #{type,jdbcType=INTEGER},
      score = #{score,jdbcType=DOUBLE},
      is_item = #{is_item,jdbcType=INTEGER},
      right_key = #{right_key,jdbcType=VARCHAR},
      stem = #{stem,jdbcType=LONGVARCHAR},
      analysis = #{analysis,jdbcType=LONGVARCHAR},
      option_a = #{option_a,jdbcType=LONGVARCHAR},
      option_b = #{option_b,jdbcType=LONGVARCHAR},
      option_c = #{option_c,jdbcType=LONGVARCHAR},
      option_d = #{option_d,jdbcType=LONGVARCHAR},
      option_e = #{option_e,jdbcType=LONGVARCHAR},
      course_id= #{course_id,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Question" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    update question
    set difficulty = #{difficulty,jdbcType=INTEGER},
      belong_to = #{belong_to,jdbcType=BIGINT},
      belong_type = #{belong_type,jdbcType=INTEGER},
      classify_id = #{classify_id,jdbcType=BIGINT},
      user_id = #{user_id,jdbcType=BIGINT},
      update_time = #{update_time,jdbcType=TIMESTAMP},
      create_time = #{create_time,jdbcType=TIMESTAMP},
      is_son = #{is_son,jdbcType=INTEGER},
      type = #{type,jdbcType=INTEGER},
      score = #{score,jdbcType=DOUBLE},
      is_item = #{is_item,jdbcType=INTEGER},
      right_key = #{right_key,jdbcType=VARCHAR}
      course_id= #{course_id,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="queryQuestion" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView">
	SELECT q.id,q.stem,q.type,q.difficulty,q.belong_type,q.update_time,u.username,q.is_item,q.score,
	(select COUNT(*) from question_material where question_material.question_id=q.id) as son,
	ch.hour_title
	FROM question q 
	left join user u on u.id=q.user_id
	left join course_hour ch on ch.id=q.belong_to
	WHERE q.user_id=${userId} AND q.is_son = 1
	and q.course_id=${courseId}
	<if test="stem != null and stem != ''">
    	<![CDATA[AND q.stem LIKE '%${stem}%']]>  
    </if>
    <if test="belong_to != null ">
    	<if test="belong_to == -1">
    		AND q.belong_type = 0
    		AND q.belong_to = ${courseId}
    	</if>
    	<if test="belong_to != -1">
    	   	AND q.belong_type = 1
	    	AND q.belong_to = ${belong_to}
    	</if>
    </if>
     	<if test="type != null and type != -1">
    	
    	AND q.type = ${type}
    	</if>
    	<if test="difficulty != null ">
    	AND q.difficulty = ${difficulty}
    	</if>
	<if test="genre==0">
		<if test="list!=null">
			AND q.id not in
			<foreach item="item" index="index" collection="list" open="(" separator="," close=")">  
	             #{item}  
	       	</foreach>  
		</if>
	</if>
	ORDER BY q.create_time desc
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="queryTotalCourse" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView" resultType="java.lang.Integer">
  	SELECT COUNT(*) 
  	FROM question q 
	WHERE q.user_id=${userId} AND q.is_son = 1
	and q.course_id=${courseId}
	<if test="stem != null and stem != ''">
    	<![CDATA[AND q.stem LIKE '%${stem}%']]>  
    </if>
    <if test="belong_to != null">
    	<if test="belong_to == -1">
    		AND q.belong_type = 0
    		AND q.belong_to = ${courseId}
    	</if>
    	<if test="belong_to != -1">
    	   	AND q.belong_type = 1
	    	AND q.belong_to = ${belong_to}
    	</if>
    </if>
    	<if test="type != null and type != -1">
    	
    	AND q.type = ${type}
    	</if>
    	<if test="genre==0">
		<if test="list!=null">
			AND q.id not in
			<foreach item="item" index="index" collection="list" open="(" separator="," close=")">  
	             #{item}  
	       	</foreach>  
		</if>
	</if>
  </select>
  
  <select id="searchQuestion"  resultType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView">
	  SELECT q.id,q.stem,q.type,q.difficulty,q.score
	  	FROM  question  q
		<if test="_parameter != null">
		WHERE id in 
		 	<foreach item="item" index="index" collection="list" open="(" separator="," close=")">  
	             #{item}  
	       	</foreach>  
	  	</if> 
  </select>
    <select id="querySonQuestion" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView">
	SELECT q.id,q.stem,q.type,q.difficulty,q.belong_type,q.update_time,u.username,q.is_item,
	(select COUNT(*) from question_material where question_material.question_id=q.id) as son,
	ch.hour_title,q.score
	FROM question_material qm
	left join question q on q.id=qm.son_question_id
	left join user u on u.id=q.user_id
	left join course_hour ch on ch.id=q.belong_to
	WHERE q.user_id=${userId} AND q.is_son = 0
	and q.course_id=${courseId}
	and qm.question_id=${pid}
	ORDER BY q.create_time desc
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  <select id="querySonQuestionCount" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView" resultType="java.lang.Integer">
	SELECT  COUNT(*) 
	FROM question_material qm
	left join question q on q.id=qm.son_question_id
    WHERE q.user_id=${userId} AND q.is_son = 0
	and q.course_id=${courseId}
	and qm.question_id=${pid}
	
  </select>
  <select id="selectAllsonQuestion" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
   
    select 
    q.*
    FROM question_material qm
	left join question q on q.id=qm.son_question_id
    where  qm.question_id= #{id,jdbcType=BIGINT}
  </select>
  <select id="selectEveryQuestionTypeCount" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.QuestionView">
    select 
	SUM(CASE WHEN q.type=0 THEN 1 ELSE 0 END) AS selectQuestion,
	SUM(CASE WHEN q.type=1 THEN 1 ELSE 0 END) AS fillQuestion, 
	SUM(CASE WHEN q.type=2 THEN 1 ELSE 0 END) AS judgeQuestion,
	SUM(CASE WHEN q.type=3 THEN 1 ELSE 0 END) AS qaQuestion, 
	SUM(CASE WHEN q.type=4 THEN 1 ELSE 0 END) AS scienceQuestion,
	SUM(CASE WHEN q.type=5 THEN 1 ELSE 0 END) AS oneSelectQuestion
    FROM question q 
    where  q.course_id=${courseId}
    and q.is_son = 1
    <if test="belong_type == 1">
    AND q.belong_type=1 
    AND q.belong_to BETWEEN ${chapterListStart} AND ${chapterListEnd}
    </if>
  </select>
</mapper>