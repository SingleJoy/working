<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.base.mapper.NotificationMapper" >
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.base.po.Notification" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="notice_type_id" property="notice_type_id" jdbcType="INTEGER" />
    <result column="notice_time" property="notice_time" jdbcType="TIMESTAMP" />
    <result column="create_time" property="create_time" jdbcType="TIMESTAMP" />
    <result column="is_read" property="is_read" jdbcType="INTEGER" />
    <result column="other_user_id" property="other_user_id" jdbcType="BIGINT" />
    <result column="source_id" property="source_id" jdbcType="BIGINT" />
    <result column="source_type" property="source_type" jdbcType="INTEGER" />
    <result column="question_id" property="question_id" jdbcType="BIGINT" />
    <result column="course_hour_id" property="course_hour_id" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    id, user_id, notice_type_id, notice_time, create_time, is_read, other_user_id, source_id, 
    source_type, question_id, course_hour_id
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from notification
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    delete from notification
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.base.po.Notification" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into notification (user_id, notice_type_id, notice_time, 
      create_time, is_read, other_user_id, 
      source_id, source_type, question_id, course_hour_id
      )
    values (#{user_id,jdbcType=BIGINT}, #{notice_type_id,jdbcType=INTEGER}, #{notice_time,jdbcType=TIMESTAMP}, 
      #{create_time,jdbcType=TIMESTAMP}, #{is_read,jdbcType=INTEGER}, #{other_user_id,jdbcType=BIGINT}, 
      #{source_id,jdbcType=BIGINT},  #{source_type,jdbcType=INTEGER},  #{question_id,jdbcType=BIGINT}, #{course_hour_id,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.Notification" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into notification
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        user_id,
      </if>
      <if test="notice_type_id != null" >
        notice_type_id,
      </if>
      <if test="notice_time != null" >
        notice_time,
      </if>
      <if test="create_time != null" >
        create_time,
      </if>
      <if test="is_read != null" >
        is_read,
      </if>
      <if test="other_user_id != null" >
        other_user_id,
      </if>
      <if test="source_id != null" >
        source_id,
      </if>
      <if test="source_type != null" >
        source_type,
      </if>
      <if test="question_id != null" >
        question_id,
      </if>
      <if test="course_hour_id != null" >
        course_hour_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="notice_type_id != null" >
        #{notice_type_id,jdbcType=INTEGER},
      </if>
      <if test="notice_time != null" >
        #{notice_time,jdbcType=TIMESTAMP},
      </if>
      <if test="create_time != null" >
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_read != null" >
        #{is_read,jdbcType=INTEGER},
      </if>
      <if test="other_user_id != null" >
        #{other_user_id,jdbcType=BIGINT},
      </if>
      <if test="source_id != null" >
        #{source_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null" >
        #{source_type,jdbcType=INTEGER},
      </if>
      <if test="question_id != null" >
        #{question_id,jdbcType=BIGINT},
      </if>
      <if test="course_hour_id != null" >
        #{course_hour_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.Notification" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    update notification
    <set >
      <if test="user_id != null" >
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="notice_type_id != null" >
        notice_type_id = #{notice_type_id,jdbcType=INTEGER},
      </if>
      <if test="notice_time != null" >
        notice_time = #{notice_time,jdbcType=TIMESTAMP},
      </if>
      <if test="create_time != null" >
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_read != null" >
        is_read = #{is_read,jdbcType=INTEGER},
      </if>
      <if test="other_user_id != null" >
        other_user_id = #{other_user_id,jdbcType=BIGINT},
      </if>
      <if test="source_id != null" >
        source_id = #{source_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null" >
        source_type = #{source_type,jdbcType=INTEGER},
      </if>
      <if test="question_id != null" >
        question_id = #{question_id,jdbcType=BIGINT},
      </if>
      <if test="course_hour_id != null" >
        course_hour_id = #{course_hour_id,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.base.po.Notification" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Dec 02 14:29:10 CST 2016.
    -->
    update notification
    set user_id = #{user_id,jdbcType=BIGINT},
      notice_type_id = #{notice_type_id,jdbcType=INTEGER},
      notice_time = #{notice_time,jdbcType=TIMESTAMP},
      create_time = #{create_time,jdbcType=TIMESTAMP},
      is_read = #{is_read,jdbcType=INTEGER},
      other_user_id = #{other_user_id,jdbcType=BIGINT},
      source_id = #{source_id,jdbcType=BIGINT},
      source_type = #{source_type,jdbcType=INTEGER},
      question_id = #{question_id,jdbcType=BIGINT},
      course_hour_id = #{course_hour_id,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
   <select id="queryNotification" resultType="cn.bnsr.edu_yun.frontstage.base.view.NotificationView">
  	 SELECT n.id,n.notice_type_id AS type,n.other_user_id,
  	 		n.source_id,n.source_type,n.question_id,n.notice_time,n.is_read,
			u.username AS other_username,
			c.title AS course_title,
			q.title AS question_title,
			t.msg1,t.msg2,t.msg3,n.course_hour_id
	FROM notification n 
	LEFT JOIN USER u ON u.id=n.other_user_id 
	LEFT JOIN course c ON c.id=n.source_id
	LEFT JOIN topic_question q ON q.id=n.question_id
	LEFT JOIN notice_type t ON t.id=n.notice_type_id
 	WHERE  n.user_id =#{user_id,jdbcType=BIGINT}
			 AND  NOW()>n.notice_time ORDER BY
		   n.is_read DESC, n.notice_time DESC 
			LIMIT ${startLine},${rows}
   </select>
     <select id="queryNotificationCount"  resultType="java.lang.Long">
  	 SELECT count(n.id)
			 FROM notification n 
			WHERE n.source_type = ${type} AND n.user_id =#{user_id,jdbcType=BIGINT}
			 AND  NOW()>n.notice_time
			
   </select>
    <select id="queryNoReadCount"  resultType="java.lang.Long">
  	 SELECT count(n.id)
			 FROM notification n 
		 WHERE n.source_type = ${type} AND n.user_id =#{user_id,jdbcType=BIGINT}
		 and n.is_read=1
		and  NOW()>n.notice_time
   </select>
</mapper>