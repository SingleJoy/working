<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.tiku.mapper.ExamMapper" >
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="test_paper_id" property="test_paper_id" jdbcType="BIGINT" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="exam_hour" property="exam_hour" jdbcType="VARCHAR" />
    <result column="exam_score" property="exam_score" jdbcType="DOUBLE" />
    <result column="exam_type" property="exam_type" jdbcType="INTEGER" />
    <result column="marking_user_id" property="marking_user_id" jdbcType="BIGINT" />
    <result column="marking_time" property="marking_time" jdbcType="TIMESTAMP" />
    <result column="grade" property="grade" jdbcType="INTEGER" />
    <result column="exam_comment" property="exam_comment" jdbcType="VARCHAR" />
    <result column="submit_time" property="submit_time" jdbcType="TIMESTAMP" />
    <result column="class_id" property="class_id" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    id, user_id, test_paper_id, status, exam_hour, exam_score, exam_type, marking_user_id, 
    marking_time, grade, exam_comment, submit_time,class_id
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from exam
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    delete from exam
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into exam (user_id, test_paper_id, status, 
      exam_hour, exam_score, exam_type, 
      marking_user_id, marking_time, grade, 
      exam_comment, submit_time)
    values (#{user_id,jdbcType=BIGINT}, #{test_paper_id,jdbcType=BIGINT}, #{status,jdbcType=INTEGER}, 
      #{exam_hour,jdbcType=VARCHAR}, #{exam_score,jdbcType=DOUBLE}, #{exam_type,jdbcType=INTEGER}, 
      #{marking_user_id,jdbcType=BIGINT}, #{marking_time,jdbcType=TIMESTAMP}, #{grade,jdbcType=INTEGER}, 
      #{exam_comment,jdbcType=VARCHAR}, #{submit_time,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into exam
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        user_id,
      </if>
      <if test="test_paper_id != null" >
        test_paper_id,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="exam_hour != null" >
        exam_hour,
      </if>
      <if test="exam_score != null" >
        exam_score,
      </if>
      <if test="exam_type != null" >
        exam_type,
      </if>
      <if test="marking_user_id != null" >
        marking_user_id,
      </if>
      <if test="marking_time != null" >
        marking_time,
      </if>
      <if test="grade != null" >
        grade,
      </if>
      <if test="exam_comment != null" >
        exam_comment,
      </if>
      <if test="submit_time != null" >
        submit_time,
      </if>
      <if test="class_id != null" >
        class_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="test_paper_id != null" >
        #{test_paper_id,jdbcType=BIGINT},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="exam_hour != null" >
        #{exam_hour,jdbcType=VARCHAR},
      </if>
      <if test="exam_score != null" >
        #{exam_score,jdbcType=DOUBLE},
      </if>
      <if test="exam_type != null" >
        #{exam_type,jdbcType=INTEGER},
      </if>
      <if test="marking_user_id != null" >
        #{marking_user_id,jdbcType=BIGINT},
      </if>
      <if test="marking_time != null" >
        #{marking_time,jdbcType=TIMESTAMP},
      </if>
      <if test="grade != null" >
        #{grade,jdbcType=INTEGER},
      </if>
      <if test="exam_comment != null" >
        #{exam_comment,jdbcType=VARCHAR},
      </if>
      <if test="submit_time != null" >
        #{submit_time,jdbcType=TIMESTAMP},
      </if>
      <if test="class_id != null" >
        #{class_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    update exam
    <set >
      <if test="user_id != null" >
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="test_paper_id != null" >
        test_paper_id = #{test_paper_id,jdbcType=BIGINT},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="exam_hour != null" >
        exam_hour = #{exam_hour,jdbcType=VARCHAR},
      </if>
      <if test="exam_score != null" >
        exam_score = #{exam_score,jdbcType=DOUBLE},
      </if>
      <if test="exam_type != null" >
        exam_type = #{exam_type,jdbcType=INTEGER},
      </if>
      <if test="marking_user_id != null" >
        marking_user_id = #{marking_user_id,jdbcType=BIGINT},
      </if>
      <if test="marking_time != null" >
        marking_time = #{marking_time,jdbcType=TIMESTAMP},
      </if>
      <if test="grade != null" >
        grade = #{grade,jdbcType=INTEGER},
      </if>
      <if test="exam_comment != null" >
        exam_comment = #{exam_comment,jdbcType=VARCHAR},
      </if>
      <if test="submit_time != null" >
        submit_time = #{submit_time,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    update exam
    set user_id = #{user_id,jdbcType=BIGINT},
      test_paper_id = #{test_paper_id,jdbcType=BIGINT},
      status = #{status,jdbcType=INTEGER},
      exam_hour = #{exam_hour,jdbcType=VARCHAR},
      exam_score = #{exam_score,jdbcType=DOUBLE},
      exam_type = #{exam_type,jdbcType=INTEGER},
      marking_user_id = #{marking_user_id,jdbcType=BIGINT},
      marking_time = #{marking_time,jdbcType=TIMESTAMP},
      grade = #{grade,jdbcType=INTEGER},
      exam_comment = #{exam_comment,jdbcType=VARCHAR},
      submit_time = #{submit_time,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
    <select id="selectStatus" resultMap="BaseResultMap" parameterType="cn.bnsr.edu_yun.frontstage.tiku.po.Exam" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 06 10:04:22 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from exam
    where user_id=${user_id} 
    AND test_paper_id=${test_paper_id} 
    AND class_id=${class_id} 
     ORDER BY id DESC LIMIT 1  
  </select>
    <select id="queryExam" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView">
	SELECT tp.id as test_paper_id ,u.id as user_id,u.icon as user_icon,u.username,ch.hour_title,e.submit_time,e.id,
	tp.total_number,tp.total_score,e.exam_score
	FROM exam e 
	LEFT JOIN test_paper tp ON e.test_paper_id=tp.id
	LEFT JOIN course_hour ch ON tp.course_hour_id=ch.id
	LEFT JOIN USER u ON u.id=e.user_id

	WHERE e.status=${status} 
	and ch.course_id=${courseId}
	and exam_type=${exam_type}
	<if test="exam_type==1">
	and ch.check_status!=1
	</if>
	AND e.class_id=${class_id}
	ORDER BY e.submit_time desc
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  <select id="queryExamCount" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="java.lang.Integer">
	SELECT COUNT(*)  FROM exam e 
	LEFT JOIN test_paper tp ON e.test_paper_id=tp.id
	LEFT JOIN course_hour ch ON tp.course_hour_id=ch.id
	LEFT JOIN USER u ON u.id=e.user_id
	
	WHERE e.status=${status} 
	and ch.course_id=${courseId}
	and exam_type=${exam_type}
	<if test="exam_type==1">
	and ch.check_status!=1
	</if>
	AND e.class_id=${class_id}
  </select>
  <select id="queryMyExam" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView">
	SELECT e.id,e.class_id,e.exam_score,e.status,e.submit_time,e.grade,t.name,t.total_number,t.id as test_paper_id,c.title,c.id as courseId,
	(SELECT COUNT(ea.id) FROM exam_answer ea WHERE ea.exam_id=e.id AND ea.is_right=0) AS right_number
	FROM exam e
 	LEFT JOIN test_paper t ON e.test_paper_id=t.id
	LEFT JOIN course c ON t.course_id=c.id
	WHERE e.user_id=${user_id} AND e.exam_type=${exam_type}
	ORDER BY e.submit_time desc
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="queryMyCommunityExam" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView">
	SELECT e.id,e.class_id,e.exam_score,e.status,e.submit_time,e.grade,t.name,t.total_number,t.id as test_paper_id,c.title,c.id as courseId,
	(SELECT COUNT(ea.id) FROM exam_answer ea WHERE ea.exam_id=e.id AND ea.is_right=0) AS right_number
	FROM exam e
 	LEFT JOIN test_paper t ON e.test_paper_id=t.id
	LEFT JOIN course c ON t.course_id=c.id
	INNER JOIN class_belongs cb ON e.class_id=cb.class_id AND cb.source_type=${community_type} AND cb.source_id=${community_id} AND cb.status=0 AND e.status=0
	WHERE e.user_id=${user_id} AND e.exam_type=${exam_type}
	ORDER BY e.submit_time desc
	<if test="rows!=null and rows!=0">
	LIMIT ${startLine},${rows}
	</if>
  </select>
  
  <select id="queryMyCommunityExamCount" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="java.lang.Integer">
	SELECT count(e.id)
	FROM exam e
 	LEFT JOIN test_paper t ON e.test_paper_id=t.id
	LEFT JOIN course c ON t.course_id=c.id
	INNER JOIN class_belongs cb ON e.class_id=cb.class_id AND cb.source_type=${community_type} AND cb.source_id=${community_id} AND cb.status=0 AND e.status=${status}
	WHERE e.user_id=${user_id} AND e.exam_type=${exam_type}
  </select>
  
  <select id="queryMyExamCount" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="java.lang.Integer">
	SELECT COUNT(*)  FROM exam e 
	WHERE e.user_id=${user_id} AND e.exam_type=${exam_type}
	
  </select>
  <select id="queryExamGrade" parameterType="cn.bnsr.edu_yun.frontstage.tiku.view.ExamView" resultType="java.lang.Integer">
	SELECT e.grade FROM exam e 
LEFT JOIN test_paper t ON e.test_paper_id=t.id
WHERE e.user_id=${user_id}  AND t.id=${test_paper_id} AND e.class_id=${class_id}
ORDER BY e.exam_score DESC LIMIT 1
	
  </select>
</mapper>