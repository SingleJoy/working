<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.base.mapper.UserMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.base.po.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="username" jdbcType="VARCHAR" property="username" />
    <result column="password" jdbcType="VARCHAR" property="password" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="create_time" jdbcType="TIMESTAMP" property="create_time" />
    <result column="last_login_time" jdbcType="TIMESTAMP" property="last_login_time" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="login_count" jdbcType="INTEGER" property="login_count" />
    <result column="user_type" jdbcType="VARCHAR" property="user_type" />
    <result column="wealth" jdbcType="DOUBLE" property="wealth" />
    <result column="property_id" jdbcType="BIGINT" property="property_id" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
    <result column="score" jdbcType="BIGINT" property="score" />
    <result column="realname" jdbcType="VARCHAR" property="realname" />
    <result column="email" jdbcType="VARCHAR" property="email" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="sign_type" jdbcType="INTEGER" property="sign_type" />
    <result column="sign_ip" jdbcType="VARCHAR" property="sign_ip" />
    <result column="last_login_ip" jdbcType="VARCHAR" property="last_login_ip" />
    <result column="is_default_img" jdbcType="INTEGER" property="is_default_img" />
    <result column="level" jdbcType="INTEGER" property="level" />
    <association property="user_property" resultMap="user_property"/>
  </resultMap>
  <resultMap id="user_property" type="cn.bnsr.edu_yun.frontstage.base.po.UserProperty">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 05 10:31:12 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="attent_count" jdbcType="INTEGER" property="attent_count" />
      <result column="agree_count" jdbcType="INTEGER" property="agree_count" />
    <result column="is_attented_count" jdbcType="INTEGER" property="is_attented_count" />
    <result column="upload_count" jdbcType="INTEGER" property="upload_count" />
    <result column="score" jdbcType="DOUBLE" property="score" />
    <result column="public_file_count" jdbcType="INTEGER" property="public_file_count" />
    <result column="private_file_count" jdbcType="INTEGER" property="private_file_count" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    id, username, password, phone, create_time, last_login_time, status, login_count, 
    user_type, wealth, property_id, icon, score, realname, email, remarks, sign_type, 
    sign_ip, last_login_ip, is_default_img
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from user
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    delete from user
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.base.po.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user (username, password, phone, 
      create_time, last_login_time, status, 
      login_count, user_type, wealth, 
      property_id, icon, score, 
      realname, email, remarks,
      sign_type, sign_ip, last_login_ip, is_default_img
      )
    values (#{username,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR}, #{phone,jdbcType=VARCHAR}, 
      #{create_time,jdbcType=TIMESTAMP}, #{last_login_time,jdbcType=TIMESTAMP}, #{status,jdbcType=VARCHAR}, 
      #{login_count,jdbcType=INTEGER}, #{user_type,jdbcType=VARCHAR}, #{wealth,jdbcType=DOUBLE}, 
      #{property_id,jdbcType=BIGINT}, #{icon,jdbcType=VARCHAR}, #{score,jdbcType=BIGINT}, 
      #{realname,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR}, #{remarks,jdbcType=VARCHAR},
      #{sign_type,jdbcType=INTEGER}, #{sign_ip,jdbcType=VARCHAR}, #{last_login_ip,jdbcType=VARCHAR},
      #{is_default_img,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="username != null">
        username,
      </if>
      <if test="password != null">
        password,
      </if>
      <if test="phone != null">
        phone,
      </if>
      <if test="create_time != null">
        create_time,
      </if>
      <if test="last_login_time != null">
        last_login_time,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="login_count != null">
        login_count,
      </if>
      <if test="user_type != null">
        user_type,
      </if>
      <if test="wealth != null">
        wealth,
      </if>
      <if test="property_id != null">
        property_id,
      </if>
      <if test="icon != null">
        icon,
      </if>
      <if test="score != null">
        score,
      </if>
      <if test="realname != null">
        realname,
      </if>
      <if test="email != null">
        email,
      </if>
      <if test="remarks != null">
        remarks,
      </if>
      <if test="sign_type != null">
        sign_type,
      </if>
      <if test="sign_ip != null">
        sign_ip,
      </if>
      <if test="last_login_ip != null">
        last_login_ip,
      </if>
      <if test="is_default_img != null">
        is_default_img,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="username != null">
        #{username,jdbcType=VARCHAR},
      </if>
      <if test="password != null">
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        #{phone,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null">
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="last_login_time != null">
        #{last_login_time,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="login_count != null">
        #{login_count,jdbcType=INTEGER},
      </if>
      <if test="user_type != null">
        #{user_type,jdbcType=VARCHAR},
      </if>
      <if test="wealth != null">
        #{wealth,jdbcType=DOUBLE},
      </if>
      <if test="property_id != null">
        #{property_id,jdbcType=BIGINT},
      </if>
      <if test="icon != null">
        #{icon,jdbcType=VARCHAR},
      </if>
      <if test="score != null">
        #{score,jdbcType=BIGINT},
      </if>
      <if test="realname != null">
        #{realname,jdbcType=VARCHAR},
      </if>
      <if test="email != null">
        #{email,jdbcType=VARCHAR},
      </if>
      <if test="remarks != null">
        #{remarks,jdbcType=VARCHAR},
      </if>
      <if test="sign_type != null">
        #{sign_type,jdbcType=INTEGER},
      </if>
      <if test="sign_ip != null">
        #{sign_ip,jdbcType=VARCHAR},
      </if>
       <if test="last_login_ip != null">
        #{last_login_ip,jdbcType=VARCHAR},
      </if>
      <if test="is_default_img != null">
        #{is_default_img,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    update user
    <set>
      <if test="username != null">
        username = #{username,jdbcType=VARCHAR},
      </if>
      <if test="password != null">
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        phone = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null">
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="last_login_time != null">
        last_login_time = #{last_login_time,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="login_count != null">
        login_count = #{login_count,jdbcType=INTEGER},
      </if>
      <if test="user_type != null">
        user_type = #{user_type,jdbcType=VARCHAR},
      </if>
      <if test="wealth != null">
        wealth = #{wealth,jdbcType=DOUBLE},
      </if>
      <if test="property_id != null">
        property_id = #{property_id,jdbcType=BIGINT},
      </if>
      <if test="icon != null">
        icon = #{icon,jdbcType=VARCHAR},
      </if>
      <if test="score != null">
        score = #{score,jdbcType=BIGINT},
      </if>
      <if test="realname != null">
        realname = #{realname,jdbcType=VARCHAR},
      </if>
      <if test="email != null">
        email = #{email,jdbcType=VARCHAR},
      </if>
      <if test="remarks != null">
        remarks = #{remarks,jdbcType=VARCHAR},
      </if>
       <if test="sign_type != null">
        sign_type = #{sign_type,jdbcType=INTEGER},
      </if>
      <if test="sign_ip != null">
        sign_ip = #{sign_ip,jdbcType=VARCHAR},
      </if>
       <if test="last_login_ip != null">
        last_login_ip = #{last_login_ip,jdbcType=VARCHAR},
      </if>
      <if test="is_default_img != null">
        is_default_img = #{is_default_img,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.base.po.User">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 30 15:33:41 CST 2016.
    -->
    update user
    set username = #{username,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      phone = #{phone,jdbcType=VARCHAR},
      create_time = #{create_time,jdbcType=TIMESTAMP},
      last_login_time = #{last_login_time,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=VARCHAR},
      login_count = #{login_count,jdbcType=INTEGER},
      user_type = #{user_type,jdbcType=VARCHAR},
      wealth = #{wealth,jdbcType=DOUBLE},
      property_id = #{property_id,jdbcType=BIGINT},
      icon = #{icon,jdbcType=VARCHAR},
      score = #{score,jdbcType=BIGINT},
      realname = #{realname,jdbcType=VARCHAR},
      email = #{email,jdbcType=VARCHAR},
      remarks = #{remarks,jdbcType=VARCHAR},
      sign_type = #{sign_type,jdbcType=INTEGER},
      sign_ip = #{sign_ip,jdbcType=VARCHAR},
      last_login_ip = #{last_login_ip,jdbcType=VARCHAR},
      is_default_img = #{is_default_img,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
   <select id="selectByUsername" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 20 09:34:25 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from user
    where username = #{username,jdbcType=VARCHAR}
  </select>
  <select id="selectByPhone" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 20 09:34:25 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from user
    where phone = #{phone,jdbcType=VARCHAR} LIMIT 1
  </select>
    <select id="selectByEmail" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 20 09:34:25 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from user
    where email = #{email,jdbcType=VARCHAR}
  </select>
  <select id="selectByUsernameAndPassword" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 20 09:34:25 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from user
    where username = #{username,jdbcType=VARCHAR} 
    and password = #{password,jdbcType=VARCHAR}
  </select>
  <select id="queryNewAttent" parameterType="java.lang.Long" resultMap="BaseResultMap">
  	SELECT u.id,u.username,(CASE WHEN u.is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE u.icon END) AS icon
  	FROM user u 
  	WHERE u.id
  	IN(SELECT t.id  
  	   FROM (SELECT a.attent_user_id as id
  	   		 FROM user_attent a 
  	   		 <if test="_parameter != null">
		  	 WHERE a.user_id = #{_parameter}
		  	 </if>
  	   		 ORDER BY  a.attent_time DESC LIMIT 3
  	   		 ) t 
  	  )
  </select>
   <select id="selectAllNum" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    user,user_property
    WHERE  user.property_id=user_property.id  ORDER BY user_property.upload_count DESC  LIMIT 0,10
    
  </select>
  
  <select id="find" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserView" resultMap="BaseResultMap" >
	SELECT *,<if test="user_type == 0">MIN(a.eve) AS level,</if>COUNT(DISTINCT a.sl_id) AS login_count FROM(
	SELECT u.id, u.username, u.password,<if test="user_type == 0">r.level AS eve,</if> u.phone,u.create_time,u.status, u.user_type, u.wealth, u.property_id, (CASE WHEN u.is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE u.icon END) AS icon, u.score, u.realname, u.email, u.remarks, u.sign_type, 
    u.sign_ip, sl.id AS sl_id,sl.create_time AS last_login_time,sl.remote_ip AS last_login_ip
    FROM user u LEFT JOIN sys_log sl ON sl.user_id=u.id AND sl.log_type=1
    <if test="user_type == 0">
    	LEFT JOIN user_role ur ON ur.user_id=u.id LEFT JOIN role r ON ur.role_id=r.id
    </if>
    <!-- <if test="roleIds != null and roleIds != ''">
    	left join user_role ur ON ur.user_id=u.id
    </if> --> 
    WHERE 1=1
    <if test="user_type == 0">
    	 AND u.user_type =0
    </if>
    <if test="user_type == 1">
    	 AND u.user_type !=0
    </if>
    <if test="roleIds != null and roleIds != ''">
    	 AND ur.role_id IN (${roleIds})
    </if>
    <if test="username != null and username != ''">
    	<![CDATA[AND u.username LIKE '%${username}%']]>  
    </if>
    <if test="phone != null and phone != ''">
    	<![CDATA[AND u.phone LIKE '%${phone}%']]>  
    </if>
    <if test="last_login_ip != null and last_login_ip != ''">
    	<![CDATA[AND sl.remote_ip LIKE '%${last_login_ip}%']]>  
    </if>
    <if test="serach_time == 0 and timeStart != null and timeStart != ''">
   		<![CDATA[ AND u.create_time >= '${timeStart}']]>  
    </if>
    <if test="serach_time == 0 and timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND u.create_time <= '${timeEnd}']]>  
    </if>
    <if test="serach_time == 1 and timeStart != null and timeStart != ''">
   		<![CDATA[ AND sl.create_time >= '${timeStart}']]>  
    </if>
    <if test="serach_time == 1 and timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND sl.create_time <= '${timeEnd}']]>  
    </if>
    <if test="sign_type != null and sign_type !=-1">
      	AND u.sign_type = ${sign_type}
    </if>
    ORDER BY sl.create_time DESC) a
    GROUP BY a.id
    <if test="sort !=null and order != null">
    	ORDER BY ${sort} ${order}
    </if>
    LIMIT ${page},${rows}
  </select>
  
  <select id="count" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserView" resultType="java.lang.Long">
  	SELECT COUNT(*) FROM (
  	SELECT *  FROM(
	SELECT u.id
    FROM user u LEFT JOIN sys_log sl ON sl.user_id=u.id AND sl.log_type=1
    <if test="roleIds != null and roleIds != ''">
    	left join user_role ur ON ur.user_id=u.id
    </if> 
    WHERE 1=1
    <if test="user_type == 0">
    	 AND u.user_type =0
    </if>
    <if test="user_type == 1">
    	 AND u.user_type !=0
    </if>
    <if test="roleIds != null and roleIds != ''">
    	 AND ur.role_id IN (${roleIds})
    </if>
    <if test="username != null and username != ''">
    	<![CDATA[AND u.username LIKE '%${username}%']]>  
    </if>
    <if test="phone != null and phone != ''">
    	<![CDATA[AND u.phone LIKE '%${phone}%']]>  
    </if>
    <if test="last_login_ip != null and last_login_ip != ''">
    	<![CDATA[AND sl.remote_ip LIKE '%${last_login_ip}%']]>  
    </if>
    <if test="serach_time == 0 and timeStart != null and timeStart != ''">
   		<![CDATA[ AND u.create_time >= '${timeStart}']]>  
    </if>
    <if test="serach_time == 0 and timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND u.create_time <= '${timeEnd}']]>  
    </if>
    <if test="serach_time == 1 and timeStart != null and timeStart != ''">
   		<![CDATA[ AND sl.create_time >= '${timeStart}']]>  
    </if>
    <if test="serach_time == 1 and timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND sl.create_time <= '${timeEnd}']]>  
    </if>
    <if test="sign_type != null and sign_type !=-1">
      	AND u.sign_type = ${sign_type}
    </if>
    ORDER BY sl.create_time DESC) a
    GROUP BY a.id ) t
  </select>
  
  <select id="queryUserStats" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView">
	SELECT   
		<if test="year != '' and month == '' ">
			DATE_FORMAT(u.create_time,'%Y-%m') days,
		</if>
		<if test="year != '' and month != '' ">
			DATE_FORMAT(u.create_time,'%Y-%m-%d') days,
		</if>
		<if test="year == '' ">
			DATE_FORMAT(u.create_time,'%Y-%m-%d') days,
		</if>
		count(*) as frontNum
	FROM user u  WHERE u.user_type=1 
	<![CDATA[AND u.create_time LIKE  '%${days}%']]>  
	GROUP BY days;
  </select>
  
  <select id="searchUser" resultType="cn.bnsr.edu_yun.frontstage.train.view.TeacherRelationView">
  	SELECT id,username as teacherName,(CASE WHEN is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE icon END) AS icon FROM user 
  	WHERE status = 1 AND 
  	<if test="str==0">
  		username = '${username}'
  	</if> 
  	<if test="str==1">
  		phone = '${username}'
  	</if> 
  	<if test="str==2">
  		email = '${username}'
  	</if> 
  	<if test="usertype != 'all' ">
	  	AND user_type = ${usertype} 
  	</if> 
  	<if test="usertype == 'all' ">
	  	AND user_type != 0
  	</if> 
  </select>
  <select id="searchUser0" resultType="cn.bnsr.edu_yun.frontstage.train.view.TeacherRelationView">
  	SELECT id,username as teacherName,(CASE WHEN is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE icon END) AS icon 
  	FROM user 
  	WHERE status = 1 AND 
  	<if test="str==0">
  		username = '${username}'
  	</if> 
  	<if test="str==1">
  		phone = '${username}'
  	</if> 
  	<if test="str==2">
  		email = '${username}'
  	</if> 
  	<!-- <if test="usertype != 'all' ">
	  	AND user_type = ${usertype} 
  	</if> 
  	<if test="usertype == 'all' ">
	  	AND user_type != 0
  	</if>  -->
  </select>
  <select id="selectUserDetail" resultType="cn.bnsr.edu_yun.frontstage.base.view.UserDetailView">
  	SELECT u.id as userId, u.username as userName, u.phone,
  		u.email, u.wealth, u.score, u.realname as realName,
  	 u.user_type as userType, ui.sex FROM user u 
  	LEFT JOIN user_info ui ON u.id=ui.user_id
  	WHERE u.id = #{_parameter}
  </select>
  <select id="queryUser" resultType="cn.bnsr.edu_yun.frontstage.base.po.User" parameterType="cn.bnsr.edu_yun.frontstage.base.po.User">
  	SELECT id,username,(CASE WHEN is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE icon END) AS icon, login_count FROM user 
  	WHERE status = "1"  
  	<if test="username != null and username !='' ">
  		AND username = #{username,jdbcType=VARCHAR}
  	</if> 
  	<if test="phone != null and phone !='' ">
  		AND phone =  #{phone,jdbcType=VARCHAR}
  	</if> 
  	<if test="email != null and email !='' ">
  		AND email =  #{email,jdbcType=VARCHAR}
  	</if>
  	<if test="password != null and password !='' ">
  		AND password =  #{password,jdbcType=VARCHAR}
  	</if>  
  	LIMIT 1
  </select>
  
  <select id="queryUserStats1" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView">
	SELECT DATE_FORMAT(u.create_time, <if test="timeType != 4">'%Y-%m-%d'</if><if test="timeType == 4">'%H'</if>) days,
	COUNT(u.id) AS newNum,${timeType} AS timeType
	FROM user u
	WHERE u.user_type IN (1,3) 
		<if  test="timeType == 0 or timeType == 1 ">
			<![CDATA[AND u.create_time LIKE  '${days}%']]>  
		</if>
		<if  test="timeType == 2 or timeType == 3 ">
		 	<![CDATA[ AND u.create_time >= '${startTime}' AND u.create_time <= '${endTime}' ]]>  
		</if>
		<if  test="timeType == 4 ">
			<![CDATA[AND u.create_time LIKE  '${days}%']]>  
		</if>
	GROUP BY days
  </select>
  
  <select id="queryUserId" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" resultType="java.lang.Long">
	SELECT DISTINCT u.id 
	FROM `user` u 
	INNER JOIN sys_log s ON s.user_id=u.id
    INNER JOIN user_info ui ON ui.user_id=u.id
	WHERE u.user_type IN (1,3) AND u.status=1 <!-- AND s.log_type=0 -->
	<![CDATA[AND u.create_time LIKE  '${days}%']]>
	<if test="province_id != null and province_id!='' and province_id!='0'.toString()">
    	<!-- 按省查询 province_id = '0'时为全国，此条件也不需要了${province_id}   '0'会被mybatis强制转换成数字，即使有'',只有toString()才可以避免-->
    	AND s.province_id = "${province_id}"
	</if>
	<if test="device != null and device !=-1">
	    <!-- device=0时查询全部，此条件也不需要了 -->
	    AND s.device = ${device}
	</if>
	<if test="sex != 0">
	    <!-- sex=0时查询全部，此条件也不需要了 -->
	    AND ui.sex = ${sex}
	</if>
  </select>
  
  
  <select id="queryAddUserStatsByMouths" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView">
	SELECT DATE_FORMAT(u.create_time,'%m') days, 
	COUNT(u.id) AS newNum FROM `user` u 
	WHERE 1=1 AND u.create_time LIKE '${year}%' 
	GROUP BY days
  </select>
  <select id="queryUserTrackView" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserTrackView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserTrackView">
	SELECT u.id AS user_id,u.username,IFNULL(continuity.continuityDays,0) AS continuityDays,
	IFNULL(duration.loginCount,0) AS loginCount,
	IFNULL(duration.loginTime,0) AS loginTime,
	IFNULL(s.studyTime,0) AS studyTime,
	IFNULL(s.studyDays,0) AS studyDays,
	IFNULL(s1.studyCourse,0) AS studyCourse,
	IFNULL(s1.studyTrain,0) AS studyTrain,
	IFNULL(u_file.uploadCount,0) AS uploadCount,
	IFNULL(u_file.downloadCount,0) AS downloadCount,
	IFNULL(appraise.appraiseCount,0) AS appraiseCount,
	IFNULL(attent1.fans,0) AS fans,
	IFNULL(attent2.concern,0) AS concern,
	IFNULL(tq.questionCount,0) AS questionCount,
	IFNULL(ta.answerCount,0) AS answerCount,
	IFNULL(cn.noteCount,0) AS noteCount
	FROM

 USER u

LEFT JOIN (SELECT  user_id,MAX(lianxu_days) AS continuityDays FROM (SELECT user_id, MAX(days) lianxu_days, MIN(login_day) start_date,MAX(login_day) end_date 
  FROM (SELECT user_id,
               @cont_day :=
               (CASE
                 WHEN (@last_user_id = user_id AND DATEDIFF(login_dt, @last_dt)=1) THEN
                  (@cont_day + 1)
                 WHEN (@last_user_id = user_id AND 1>DATEDIFF(login_dt, @last_dt)) THEN
                  (@cont_day + 0)
                 ELSE
                  1
               END) AS days,
               (@cont_ix := (@cont_ix + IF(@cont_day = 1, 1, 0))) AS cont_ix,
               @last_user_id := user_id,
               @last_dt := login_dt login_day
          FROM (SELECT  user_id, DATE(start_time) AS login_dt
                  FROM user_study_time WHERE user_id IS NOT NULL 
                 ORDER BY user_id, start_time) AS t,
               (SELECT @last_user_id := '',
                       @last_dt  := '',
                       @cont_ix  := 0,
                       @cont_day := 0) AS t1) AS t2
                  
 GROUP BY user_id, cont_ix) tt 
  GROUP BY user_id
 ORDER BY tt.lianxu_days DESC) continuity ON u.id=continuity.user_id

LEFT JOIN (
SELECT COUNT(*) AS loginCount,SUM(total_ms)  AS loginTime,ud.user_id FROM user_duration ud WHERE ud.user_id IS NOT NULL GROUP BY ud.user_id
)  duration ON duration.user_id=u.id

LEFT JOIN (SELECT SUM(study.study_time) AS studyTime,COUNT(*) AS studyDays,study.user_id FROM (SELECT SUM(ust.study_time) AS study_time,  DATE_FORMAT(ust.start_time,'%Y%m%d') AS start_time,ust.user_id FROM user_study_time ust GROUP BY DATE_FORMAT(ust.start_time,'%Y%m%d'),ust.user_id) 
study GROUP BY study.user_id) s ON s.user_id=u.id

LEFT JOIN (SELECT SUM(CASE WHEN us.source_type=0 THEN 1 ELSE 0 END) AS studyCourse,SUM(CASE WHEN us.source_type=1 THEN 1 ELSE 0 END) AS studyTrain,us.user_id FROM user_study us WHERE us.status!=1 AND us.status!=2  GROUP BY us.user_id ) s1
ON s1.user_id=u.id

LEFT JOIN (SELECT SUM(CASE WHEN uf.type=1 THEN 1 ELSE 0 END) AS uploadCount,SUM(CASE WHEN uf.type=5 THEN 1 ELSE 0 END) AS downloadCount,
uf.user_id FROM user_file uf WHERE uf.user_id IS NOT NULL  GROUP BY uf.user_id) u_file ON u_file.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS appraiseCount,ua.user_id FROM user_appraise ua GROUP BY ua.user_id) appraise ON appraise.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS fans,ua.attent_user_id FROM user_attent ua GROUP BY ua.attent_user_id) attent1 ON attent1.attent_user_id=u.id
LEFT JOIN (SELECT COUNT(*) AS concern,ua.user_id FROM user_attent ua GROUP BY ua.user_id) attent2 ON attent2.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS questionCount,tq.user_id FROM topic_question tq GROUP BY tq.user_id) tq ON tq.user_id=u.id
LEFT JOIN (SELECT COUNT(*) AS answerCount,ta.user_id FROM topic_answer ta GROUP BY ta.user_id) ta ON ta.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS noteCount,cn.user_id FROM course_note cn GROUP BY cn.user_id) cn ON cn.user_id=u.id
where u.user_type!=0
<if test="sort !=null and order != null">
    	ORDER BY ${sort} ${order}
    </if>
    LIMIT ${page},${rows}
  </select>
   <select id="countAllUser"  resultType="java.lang.Long">
   select count(*) from user where user.user_type!=0
 </select>
 <select id="queryme" parameterType="java.lang.Long" resultType="cn.bnsr.edu_yun.backstage.base.view.UserView">
	 SELECT *,COUNT(DISTINCT a.sl_id) AS login_count FROM 
	( SELECT u.id, u.username,r.name AS roleNames,
	  u.remarks, u.sign_ip, sl.id AS sl_id,sl.create_time AS logintime,sl.remote_ip AS last_login_ip 
	FROM user u LEFT JOIN user_role ur ON u.id=ur.user_id LEFT JOIN role r ON r.id=ur.role_id
	LEFT JOIN sys_log sl ON sl.user_id=u.id AND sl.log_type=1 
	WHERE u.user_type=0 AND u.id=#{id,jdbcType=BIGINT}
	ORDER BY sl.create_time DESC) a 
	GROUP BY a.id limit 1
 
 </select>
 
 <select id="queryUserTrackClassView" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserTrackView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserTrackView">
	SELECT u.id AS user_id,u.username,IFNULL(continuity.continuityDays,0) AS continuityDays,
	IFNULL(s.studyTime,0) AS studyTime,
	IFNULL(s.studyDays,0) AS studyDays,
	IFNULL(tq.questionCount,0) AS questionCount,
	IFNULL(ta.answerCount,0) AS answerCount,
	IFNULL(cn.noteCount,0) AS noteCount
	FROM

 USER u
 join user_study us on us.user_id=u.id and us.source_id=${class_id}
LEFT JOIN (SELECT  user_id,MAX(lianxu_days) AS continuityDays FROM (SELECT user_id, MAX(days) lianxu_days, MIN(login_day) start_date,MAX(login_day) end_date 
  FROM (SELECT user_id,
               @cont_day :=
               (CASE
                 WHEN (@last_user_id = user_id AND DATEDIFF(login_dt, @last_dt)=1) THEN
                  (@cont_day + 1)
                 WHEN (@last_user_id = user_id AND 1>DATEDIFF(login_dt, @last_dt)) THEN
                  (@cont_day + 0)
                 ELSE
                  1
               END) AS days,
               (@cont_ix := (@cont_ix + IF(@cont_day = 1, 1, 0))) AS cont_ix,
               @last_user_id := user_id,
               @last_dt := login_dt login_day
          FROM (SELECT  user_id, DATE(start_time) AS login_dt
                  FROM user_study_time WHERE user_id IS NOT NULL 
                  and class_id=${class_id}
                 ORDER BY user_id, start_time) AS t,
               (SELECT @last_user_id := '',
                       @last_dt  := '',
                       @cont_ix  := 0,
                       @cont_day := 0) AS t1) AS t2
                  
 GROUP BY user_id, cont_ix) tt 
  GROUP BY user_id
 ORDER BY tt.lianxu_days DESC) continuity ON u.id=continuity.user_id

LEFT JOIN (SELECT SUM(study.study_time) AS studyTime,COUNT(*) AS studyDays,study.user_id FROM (SELECT SUM(ust.study_time) AS study_time,  DATE_FORMAT(ust.start_time,'%Y%m%d') AS start_time,ust.user_id FROM user_study_time ust 
where ust.class_id=${class_id}
GROUP BY DATE_FORMAT(ust.start_time,'%Y%m%d'),ust.user_id) 
study GROUP BY study.user_id) s ON s.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS questionCount,tq.user_id FROM topic_question tq 
where tq.class_id=${class_id}
GROUP BY tq.user_id) tq ON tq.user_id=u.id
LEFT JOIN (SELECT COUNT(*) AS answerCount,ta.user_id FROM topic_answer ta
LEFT JOIN topic_question t on ta.question_id=t.id 
where  t.class_id=${class_id}
 GROUP BY ta.user_id) ta ON ta.user_id=u.id

LEFT JOIN (SELECT COUNT(*) AS noteCount,cn.user_id FROM course_note cn
where cn.course_id=${course_id}
 GROUP BY cn.user_id) cn ON cn.user_id=u.id
where u.user_type!=0
<if test="sort !=null and order != null">
    	ORDER BY ${sort} ${order}
    </if>
   
  </select>
 
 
</mapper>