<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.train.mapper.UserStudyLogMapper" >
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.train.po.UserStudyLog" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="source_id" property="source_id" jdbcType="BIGINT" />
    <result column="source_type" property="source_type" jdbcType="INTEGER" />
    <result column="class_id" property="class_id" jdbcType="BIGINT" />
    <result column="create_time" property="create_time" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, user_id, source_id,source_type,class_id,create_time
  </sql>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudy" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Dec 20 15:07:28 CST 2016.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user_study_log
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        user_id,
      </if>
      <if test="source_id != null" >
        source_id,
      </if>
      <if test="source_type != null" >
        source_type,
      </if>
      <if test="class_id != null" >
        class_id,
      </if>
      <if test="create_time != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="user_id != null" >
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="source_id != null" >
        #{source_id,jdbcType=BIGINT},
      </if>
      <if test="source_type != null" >
        #{source_type,jdbcType=INTEGER},
      </if>
      <if test="class_id != null" >
        #{class_id,jdbcType=BIGINT},
      </if>
      <if test="create_time != null" >
        #{create_time,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  
  <select id="findUserStudyLogByUSLView" parameterType="cn.bnsr.edu_yun.frontstage.train.view.UserStudyLogView" resultType="java.lang.Long">
	select id from user_study_log 
	where user_id=${user_id } 
	AND source_id = ${source_id } 
	AND source_type=${source_type }
	AND class_id=${class_id}
	AND create_time like '${create_time_model}%' 
	limit 1;
  </select>
  
  <select id="queryUserStudyLogStati" parameterType="cn.bnsr.edu_yun.backstage.content.view.ContentStatiView" resultType="cn.bnsr.edu_yun.backstage.content.view.ContentStatiView">
  	SELECT DATE_FORMAT(usl.create_time, '%Y-%m-%d') days, COUNT(usl.class_id) AS newNum
	FROM user_study_log usl 
	<if test="source_type==0">
		INNER JOIN course cou
		ON usl.source_id=cou.id
		AND cou.type=0
	</if>
	<if test="source_type==1">
		INNER JOIN train t
		ON usl.source_id = t.id 
		AND t.type=${train_type}
	</if>
	WHERE usl.source_type=${source_type } 
		<if  test="monthType == 0 or monthType == 1 ">
			<![CDATA[AND usl.create_time LIKE  '${days}%']]>  
		</if>
		<if  test="monthType == 2 or monthType == 3 ">
		 	<![CDATA[ AND (usl.create_time >= '${startTime}' AND usl.create_time <= '${endTime}' )]]>  
		</if>
	GROUP BY days
  </select>
  </mapper>