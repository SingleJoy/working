<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.base.mapper.OnlineUserMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.base.po.OnlineUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="user_id" jdbcType="BIGINT" property="user_id" />
    <result column="device" jdbcType="INTEGER" property="device" />
    <result column="province_id" jdbcType="VARCHAR" property="province_id" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="create_time" jdbcType="TIMESTAMP" property="create_time" />
    <result column="is_add" jdbcType="INTEGER" property="is_add" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    id, user_id, device, province_id, address, create_time, is_add
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from online_user
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    delete from online_user
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.base.po.OnlineUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into online_user (user_id, device, province_id, 
      address, create_time, is_add
      )
    values (#{user_id,jdbcType=BIGINT}, #{device,jdbcType=INTEGER}, #{province_id,jdbcType=VARCHAR}, 
      #{address,jdbcType=VARCHAR}, #{create_time,jdbcType=TIMESTAMP}, #{is_add,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.OnlineUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into online_user
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="user_id != null">
        user_id,
      </if>
      <if test="device != null">
        device,
      </if>
      <if test="province_id != null">
        province_id,
      </if>
      <if test="address != null">
        address,
      </if>
      <if test="create_time != null">
        create_time,
      </if>
      <if test="is_add != null">
        is_add,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="user_id != null">
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="device != null">
        #{device,jdbcType=INTEGER},
      </if>
      <if test="province_id != null">
        #{province_id,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null">
        #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_add != null">
        #{is_add,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.OnlineUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    update online_user
    <set>
      <if test="user_id != null">
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="device != null">
        device = #{device,jdbcType=INTEGER},
      </if>
      <if test="province_id != null">
        province_id = #{province_id,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        address = #{address,jdbcType=VARCHAR},
      </if>
      <if test="create_time != null">
        create_time = #{create_time,jdbcType=TIMESTAMP},
      </if>
      <if test="is_add != null">
        is_add = #{is_add,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.base.po.OnlineUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Oct 23 16:51:54 CST 2017.
    -->
    update online_user
    set user_id = #{user_id,jdbcType=BIGINT},
      device = #{device,jdbcType=INTEGER},
      province_id = #{province_id,jdbcType=VARCHAR},
      address = #{address,jdbcType=VARCHAR},
      create_time = #{create_time,jdbcType=TIMESTAMP},
      is_add = #{is_add,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="queryAvgOnline" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" resultType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView">
    SELECT  
	<choose>
	<!-- 按小时 -->
	<when test="timeUnit == 0">DATE_FORMAT(x.create_time,'%H')</when>
	<!-- 按天 -->
	<when test="timeUnit == 1">DATE_FORMAT(x.create_time,'%Y-%m-%d')</when>
	<!-- 按周 -->
	<when test="timeUnit == 2">DATE_FORMAT(SUBDATE(x.create_time,DATE_FORMAT(x.create_time,'%w')-1),'%Y-%m-%d')</when>
	<!-- 按月 -->
	<when test="timeUnit == 3">CONCAT(DATE_FORMAT(LAST_DAY(x.create_time),'%Y-%m-'),'01')</when>
	</choose>
	AS days,AVG(x.online_num) AS avgNum,MAX(x.online_num) AS maxNum
	FROM (SELECT ou.create_time,COUNT(DISTINCT ou.user_id) AS online_num 
	      FROM online_user ou INNER JOIN user_info ui ON ui.user_id=ou.user_id INNER JOIN user u ON u.id=ou.user_id
	      WHERE 1=1
	      <if test="status == 1">
		     AND TO_DAYS(ou.create_time)=TO_DAYS(u.create_time)
		  </if>
		  <if test="status == 2">
		     AND TO_DAYS(ou.create_time)!=TO_DAYS(u.create_time)
		  </if>
	      <if test="sex != 0">
			 <!-- sex=0时查询全部，此条件也不需要了 -->
			 AND ui.sex = ${sex}
		  </if>
	      <if test="province_id != null and province_id!='' and province_id!='0'.toString()">
	    	<!-- 按省查询 province_id = '0'时为全国，此条件也不需要了${province_id}   '0'会被mybatis强制转换成数字，即使有'',只有toString()才可以避免-->
		     AND ou.province_id = "${province_id}"
		  </if>
		  <if test="device != null and device !=-1">
			  <!-- device=0时查询全部，此条件也不需要了 -->
			  AND ou.device = ${device}
		  </if>
		  <if test="days != ''">
		   	  <![CDATA[ AND ou.create_time LIKE '${days}%' ]]>  
		  </if>
	      <if test="startTime != '' and endTime != '' ">
		   	  <![CDATA[ AND ou.create_time >= '${startTime}' AND ou.create_time < '${endTime}' ]]>  
		  </if>
	      GROUP BY ou.create_time 
	      ORDER BY ou.create_time DESC) x
	GROUP BY days
	ORDER BY days
  </select>
  
</mapper>