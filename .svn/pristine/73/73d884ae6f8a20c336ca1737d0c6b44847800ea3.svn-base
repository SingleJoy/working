<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.xbjy.mapper.LessonUserIdentityMapper" >
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.xbjy.po.LessonUserIdentity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="lesson_id" property="lesson_id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="Identity" property="identity" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    id, lesson_id, user_id, Identity
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from lesson_user_identity
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    delete from lesson_user_identity
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.po.LessonUserIdentity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into lesson_user_identity (lesson_id, user_id, Identity
      )
    values (#{lesson_id,jdbcType=BIGINT}, #{user_id,jdbcType=BIGINT}, #{identity,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.po.LessonUserIdentity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into lesson_user_identity
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="lesson_id != null" >
        lesson_id,
      </if>
      <if test="user_id != null" >
        user_id,
      </if>
      <if test="identity != null" >
        Identity,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="lesson_id != null" >
        #{lesson_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null" >
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="identity != null" >
        #{identity,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.po.LessonUserIdentity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    update lesson_user_identity
    <set >
      <if test="lesson_id != null" >
        lesson_id = #{lesson_id,jdbcType=BIGINT},
      </if>
      <if test="user_id != null" >
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="identity != null" >
        Identity = #{identity,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.po.LessonUserIdentity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 13 11:20:25 CST 2017.
    -->
    update lesson_user_identity
    set lesson_id = #{lesson_id,jdbcType=BIGINT},
      user_id = #{user_id,jdbcType=BIGINT},
      Identity = #{identity,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="findTeacher"  resultType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView">
     SELECT u.id AS user_id,u.username as user_name,ui.true_name,ul.identity,ul.id,(CASE WHEN u.is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE u.icon END) AS icon
     FROM lesson_user_identity ul 
     LEFT JOIN user u ON u.id=ul.user_id
     LEFT JOIN user_info ui ON u.id=ui.user_id
     WHERE 1=1  
     AND ul.lesson_id=#{lesson_id,jdbcType=BIGINT} 
     <if test="identity !=-1 ">
	      AND  ul.identity = #{identity,jdbcType=INTEGER} 
	 </if>
	 
     ORDER BY u.id
     <!--
	 LIMIT ${startLine},${rows}
	 -->
  </select>
  
  <select id="findUserZz"  resultType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView">
     SELECT *
     FROM lesson_user_identity 
     WHERE lesson_id = #{lesson_id,jdbcType=BIGINT}
     AND identity = 0

     ORDER BY id
     <!--
	 LIMIT ${startLine},${rows}
	 -->
  </select>
  
  
  <delete id="deleteUser"  >  
  	delete from lesson_user_identity
    where id in  
      <foreach collection="array" item = "id" open="(" separator="," close=")">  
            #{id}  
    </foreach>    
  </delete>  
  
  
  
  <select id="findUserByIdentity"  resultType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView">
     SELECT *
     FROM lesson_user_identity 
     WHERE 1=1  
     AND lesson_id=#{lesson_id,jdbcType=BIGINT}
     AND  identity = #{identity,jdbcType=INTEGER} 
	 
     ORDER BY id
     <!--
	 LIMIT ${startLine},${rows}
	 -->
  </select>
  
  <select id="findUserIdentity"  resultType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView">
     SELECT *
     FROM lesson_user_identity 
     WHERE 1=1  
     AND lesson_id=#{lesson_id,jdbcType=BIGINT}
     AND  user_id = #{user_id,jdbcType=INTEGER} 
	 
     ORDER BY id
     <!--
	 LIMIT ${startLine},${rows}
	 -->
  </select>
  
  <update id="setUserIdentity" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" >

    update lesson_user_identity
    set Identity = #{Identity,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
   <update id="setUserIdentityBylu" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" >

    update lesson_user_identity
    set Identity = #{Identity,jdbcType=BIGINT}
    where 1=1
    And lesson_id = #{lesson_id,jdbcType=BIGINT}
    And user_id = #{user_id,jdbcType=BIGINT}
  </update>
  
  <select id="countMember" resultType="java.lang.Integer" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" >
    SELECT 
    COUNT(*) 
    FROM lesson_user_identity 
    WHERE lesson_id = #{lesson_id,jdbcType=BIGINT}
    <if test="identity !=-1 ">
	      AND identity = #{identity,jdbcType=INTEGER} 
	 </if>
  </select>
  
  
  <select id="findTeacherNozd"  resultType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView" parameterType="cn.bnsr.edu_yun.frontstage.xbjy.view.LessonUserIdentityView">
     SELECT u.id AS user_id,u.username as user_name,ui.true_name,ul.identity,ul.id,(CASE WHEN u.is_default_img=0 THEN (SELECT path FROM cert_model_picture WHERE type= 2 AND defaulted = 0 order by upload_time desc limit 1) ELSE u.icon END) AS icon
     FROM lesson_user_identity ul 
     LEFT JOIN user u ON u.id=ul.user_id
     LEFT JOIN user_info ui ON u.id=ui.user_id
     WHERE 1=1  
     AND ul.lesson_id=#{lesson_id,jdbcType=BIGINT} 
	 AND  ul.identity != 2
	 
     ORDER BY u.id
     <!--
	 LIMIT ${startLine},${rows}
	 -->
  </select>
</mapper>