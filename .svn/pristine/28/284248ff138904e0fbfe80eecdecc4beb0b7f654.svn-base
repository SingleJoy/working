<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.resource.mapper.File_baseMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="filename" jdbcType="VARCHAR" property="filename" />
    <result column="path" jdbcType="VARCHAR" property="path" />
    <result column="length" jdbcType="BIGINT" property="length" />
    <result column="size" jdbcType="VARCHAR" property="size" />
    <result column="upload_time" jdbcType="TIMESTAMP" property="upload_time" />
    <result column="upload_user" jdbcType="BIGINT" property="upload_user" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="property_id" jdbcType="BIGINT" property="property_id" />
    <result column="catalog_id" jdbcType="BIGINT" property="catalog_id" />
    <result column="value" jdbcType="DOUBLE" property="value" />
    <result column="format" jdbcType="VARCHAR" property="format" />
    <result column="file_type" jdbcType="INTEGER" property="file_type" />
    <result column="check_time" jdbcType="TIMESTAMP" property="check_time" />
    <result column="reason" jdbcType="VARCHAR" property="reason" />
    <result column="delete_time" jdbcType="TIMESTAMP" property="delete_time" />
    <result column="teaching_plan_id" jdbcType="BIGINT" property="teaching_plan_id" />
     <association property="file_property" resultMap="file_property"/>
     <association property="file_catalog" resultMap="file_catalog"/>
      <association property="user" resultMap="user"/> 
      <association property="userInfo" resultMap="userInfo"/>
       <association property="file_value" resultMap="file_value"/>
   </resultMap>
  <resultMap id="file_catalog" type="cn.bnsr.edu_yun.frontstage.resource.po.File_catalog">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 28 14:22:27 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="profile" jdbcType="VARCHAR" property="profile" />
    <result column="classfication_id" jdbcType="VARCHAR" property="classfication_id" />
    <result column="column_id" jdbcType="INTEGER" property="column_id" />
    <result column="type" jdbcType="TINYINT" property="type" />
    <result column="folder_id" jdbcType="BIGINT" property="folder_id" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
     <result column="range_id" jdbcType="BIGINT" property="range_id" />
      <result column="range_type" jdbcType="INTEGER" property="range_type" />
  </resultMap>
  <resultMap id="user" type="cn.bnsr.edu_yun.frontstage.base.po.User" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 20 09:34:25 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="username" property="username" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="phone" property="phone" jdbcType="VARCHAR" />
    <result column="create_time" property="create_time" jdbcType="TIMESTAMP" />
    <result column="last_login_time" property="last_login_time" jdbcType="TIMESTAMP" />
      <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="login_count" property="login_count" jdbcType="INTEGER" />
    <result column="role" property="role" jdbcType="INTEGER" />
    <result column="wealth" property="wealth" jdbcType="BIGINT" />
    <result column="property_id" property="property_id" jdbcType="BIGINT" />
    <result column="icon" property="icon" jdbcType="VARCHAR" />
    <result column="score" property="score" jdbcType="BIGINT" />
    <result column="realname" property="realname" jdbcType="VARCHAR" />
    <result column="email" property="email" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="file_property" type="cn.bnsr.edu_yun.frontstage.resource.po.File_property">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 26 16:00:41 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="download_times" jdbcType="INTEGER" property="download_times" />
    <result column="collection_times" jdbcType="INTEGER" property="collection_times" />
    <result column="click_times" jdbcType="INTEGER" property="click_times" />
    <result column="score" jdbcType="DOUBLE" property="score" />
  </resultMap>
   <resultMap id="file_value" type="cn.bnsr.edu_yun.frontstage.resource.po.File_value">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 26 16:00:41 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="file_amount" jdbcType="BIGINT" property="file_amount" />
    <result column="file_score" jdbcType="BIGINT" property="file_score" />
  </resultMap>
  <resultMap id="userInfo" type="cn.bnsr.edu_yun.frontstage.base.po.UserInfo">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 16 15:53:21 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="user_id" jdbcType="BIGINT" />
    <result column="school" property="school" jdbcType="VARCHAR" />
    <result column="course" property="course" jdbcType="VARCHAR" />
    <result column="titles" property="titles" jdbcType="VARCHAR" />
    <result column="pubver_id" property="pubver_id" jdbcType="VARCHAR" />
    <result column="school_id" property="school_id" jdbcType="BIGINT" />
    <result column="grade_id" property="grade_id" jdbcType="INTEGER" />
    <result column="true_name" property="true_name" jdbcType="VARCHAR" />
    <result column="sex" property="sex" jdbcType="INTEGER" />
    <result column="ID_number" property="ID_number" jdbcType="VARCHAR" />
    <result column="picture1" property="picture1" jdbcType="VARCHAR" />
    <result column="picture2" property="picture2" jdbcType="VARCHAR" />
    <result column="picture3" property="picture3" jdbcType="VARCHAR" />
    <result column="apply_time" jdbcType="TIMESTAMP" property="apply_time" />
    <result column="review_time" jdbcType="TIMESTAMP" property="review_time" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    id, filename, path, length, size, upload_time, upload_user, status, property_id, 
    catalog_id, value, format, file_type,teaching_plan_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    select 
    file_base.*,file_property.*,user_info.true_name,user.username,user.icon,file_catalog.*
    from file_base
      left join file_property on file_base.property_id=file_property.id
   left join user_info on file_base.upload_user=user_info.user_id
 	left join user on file_base.upload_user=user.id
   left join file_catalog on file_base.catalog_id=file_catalog.id
    where file_base.id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    delete from file_base
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into file_base (filename, path, length, 
      size, upload_time, upload_user, 
      status, property_id, catalog_id, 
      value, format, file_type
      )
    values (#{filename,jdbcType=VARCHAR}, #{path,jdbcType=VARCHAR}, #{length,jdbcType=BIGINT}, 
      #{size,jdbcType=VARCHAR}, #{upload_time,jdbcType=TIMESTAMP}, #{upload_user,jdbcType=BIGINT}, 
      #{status,jdbcType=TINYINT}, #{property_id,jdbcType=BIGINT}, #{catalog_id,jdbcType=BIGINT}, 
      #{value,jdbcType=DOUBLE}, #{format,jdbcType=VARCHAR}, #{file_type,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into file_base
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="filename != null">
        filename,
      </if>
      <if test="path != null">
        path,
      </if>
      <if test="length != null">
        length,
      </if>
      <if test="size != null">
        size,
      </if>
      <if test="upload_time != null">
        upload_time,
      </if>
      <if test="upload_user != null">
        upload_user,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="property_id != null">
        property_id,
      </if>
      <if test="catalog_id != null">
        catalog_id,
      </if>
      <if test="value != null">
        value,
      </if>
      <if test="format != null">
        format,
      </if>
      <if test="file_type != null">
        file_type,
      </if>
      <if test="teaching_plan_id != null">
        teaching_plan_id,
      </if>
     </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="filename != null">
        #{filename,jdbcType=VARCHAR},
      </if>
      <if test="path != null">
        #{path,jdbcType=VARCHAR},
      </if>
      <if test="length != null">
        #{length,jdbcType=BIGINT},
      </if>
      <if test="size != null">
        #{size,jdbcType=VARCHAR},
      </if>
      <if test="upload_time != null">
        #{upload_time,jdbcType=TIMESTAMP},
      </if>
      <if test="upload_user != null">
        #{upload_user,jdbcType=BIGINT},
      </if>
      <if test="status != null">
        #{status,jdbcType=TINYINT},
      </if>
      <if test="property_id != null">
        #{property_id,jdbcType=BIGINT},
      </if>
      <if test="catalog_id != null">
        #{catalog_id,jdbcType=BIGINT},
      </if>
      <if test="value != null">
        #{value,jdbcType=DOUBLE},
      </if>
      <if test="format != null">
        #{format,jdbcType=VARCHAR},
      </if>
      <if test="file_type != null">
        #{file_type,jdbcType=INTEGER},
      </if>
       <if test="teaching_plan_id != null">
        #{teaching_plan_id,jdbcType=BIGINT},
      </if>
     </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    update file_base
    <set>
      <if test="filename != null">
        filename = #{filename,jdbcType=VARCHAR},
      </if>
      <if test="path != null">
        path = #{path,jdbcType=VARCHAR},
      </if>
      <if test="length != null">
        length = #{length,jdbcType=BIGINT},
      </if>
      <if test="size != null">
        size = #{size,jdbcType=VARCHAR},
      </if>
      <if test="upload_time != null">
        upload_time = #{upload_time,jdbcType=TIMESTAMP},
      </if>
      <if test="upload_user != null">
        upload_user = #{upload_user,jdbcType=BIGINT},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=TINYINT},
      </if>
      <if test="property_id != null">
        property_id = #{property_id,jdbcType=BIGINT},
      </if>
      <if test="catalog_id != null">
        catalog_id = #{catalog_id,jdbcType=BIGINT},
      </if>
      <if test="value != null">
        value = #{value,jdbcType=DOUBLE},
      </if>
      <if test="format != null">
        format = #{format,jdbcType=VARCHAR},
      </if>
      <if test="file_type != null">
        file_type = #{file_type,jdbcType=INTEGER},
      </if>
       <if test="check_time != null">
        check_time = #{check_time,jdbcType=TIMESTAMP},
      </if>
      <if test="reason != null">
        reason = #{reason,jdbcType=VARCHAR},
      </if>
       <if test="delete_time != null">
        delete_time = #{delete_time,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    update file_base
    set filename = #{filename,jdbcType=VARCHAR},
      path = #{path,jdbcType=VARCHAR},
      length = #{length,jdbcType=BIGINT},
      size = #{size,jdbcType=VARCHAR},
      upload_time = #{upload_time,jdbcType=TIMESTAMP},
      upload_user = #{upload_user,jdbcType=BIGINT},
      status = #{status,jdbcType=TINYINT},
      property_id = #{property_id,jdbcType=BIGINT},
      catalog_id = #{catalog_id,jdbcType=BIGINT},
      value = #{value,jdbcType=DOUBLE},
      format = #{format,jdbcType=VARCHAR},
      file_type = #{file_type,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
    <select id="selectAnyOne" parameterType="cn.bnsr.edu_yun.frontstage.resource.po.File_base" resultType="cn.bnsr.edu_yun.frontstage.resource.po.File_base">
      select * from file_base where 1=1
      <if test="id != null">
       and filename = #{id}
      </if>
      <if test="filename != null">
       and filename = #{filename,jdbcType=VARCHAR}
      </if>
      <if test="path != null">
      and  path = #{path,jdbcType=VARCHAR}
      </if>
      <if test="length != null">
       and length = #{length,jdbcType=BIGINT}
      </if>
      <if test="size != null">
       and size = #{size,jdbcType=VARCHAR}
      </if>
      <if test="upload_time != null">
       and upload_time = #{upload_time,jdbcType=TIMESTAMP}
      </if>
      <if test="upload_user != null">
       and upload_user = #{upload_user,jdbcType=BIGINT}
      </if>
      <if test="status != null">
       and status = #{status,jdbcType=TINYINT}
      </if>
      <if test="property_id != null">
       and property_id = #{property_id,jdbcType=BIGINT}
      </if>
      <if test="catalog_id != null">
       and catalog_id = ${catalog_id}
      </if>
      <if test="value != null">
       and value = #{value,jdbcType=DOUBLE}
      </if>
      <if test="format != null">
       and format = #{format,jdbcType=VARCHAR}
      </if>
      <if test="file_type != null">
      and  file_type = ${file_type}
      </if>
      and file_base.status=0
  </select>
  
  <select id="selectByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property
    WHERE file_base.upload_user= #{upload_user,jdbcType=BIGINT} AND file_base.catalog_id=file_catalog.id
    and file_base.property_id=file_property.id and file_base.status=0
     ORDER BY file_base.upload_time DESC LIMIT #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  <select id="selectAll" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,user
    WHERE  file_base.catalog_id=file_catalog.id AND file_base.upload_user=user.id and file_catalog.type!=3 and file_base.status=0 ORDER BY file_base.id DESC  LIMIT 0,4
    
  </select>
  
  
  <select id="queryUserFile" parameterType="cn.bnsr.edu_yun.frontstage.resource.view.FileView" resultType="cn.bnsr.edu_yun.frontstage.resource.view.FileView">
  	SELECT c.id as catalogId ,c.title as title,co.classify_name as type,b.id as fileBaseId,
  		b.upload_time as uploadTime,c.icon as image,b.property_id as propertyId
	FROM file_base b 
	INNER JOIN file_catalog c ON b.catalog_id = c.id 
    LEFT JOIN classify co ON c.column_id =  co.id
    <if test="sort != '' and sort != 1">
   		LEFT JOIN file_property p ON b.property_id = p.id
    </if>
    WHERE b.upload_user = #{userId,jdbcType=BIGINT}
    AND b.status = 0
    <if test="type != null and type != 0">
    	AND c.type = ${type}
    </if>
    <if test="sortType != '' and sortType != 1 and sort != ''">
     	ORDER BY
	    <if test="sort == 1">
	    	b.upload_time 
	    </if>
	    <if test="sort == 2">
	   		p.download_times  
	    </if>
	    <if test="sort == 3">
	   		p.score  
	    </if>
	    <if test="sort == 4">
	   		p.click_times  
	    </if>
	    <if test="sortType == 2">
	    	ASC
	    </if>
	    <if test="sortType == 3">
	    	DESC
	    </if>
    </if>
    LIMIT ${startLine},${rows}
  </select>
  <select id="getTotalFile" parameterType="cn.bnsr.edu_yun.frontstage.resource.view.FileView" resultType="java.lang.Integer" >
  	SELECT count(*)
	FROM file_base b 
	INNER JOIN file_catalog c ON b.catalog_id = c.id 
    LEFT JOIN classify co ON c.column_id =  co.id
    WHERE b.upload_user = #{userId,jdbcType=BIGINT}
    AND b.status = 0
    <if test="type != null and type !=0">
    AND c.type = ${type}
    </if>
  </select>
  <select id="queryHotFile" resultMap="BaseResultMap" >
  	SELECT b.filename,b.id
  	FROM file_base b 
  	WHERE  b.property_id 
  	IN(SELECT t.id 
  	   FROM (SELECT p.id 
  	   		 FROM file_property p 
  	   		 ORDER BY  p.click_times DESC LIMIT 5
  	   		 ) t 
  	  )
  	AND b.status = 0
  </select>
  <select id="queryRecommend" resultType="cn.bnsr.edu_yun.frontstage.resource.view.ResourceView">
  	SELECT b.filename as fileName,b.id as fileId,b.format as format,
  		u.username as uploadName,f.score as score
  	FROM file_base b 
	LEFT JOIN user u ON b.upload_user = u.id
	LEFT JOIN file_property f ON f.id = b.property_id
  	WHERE  b.property_id 
  	IN(SELECT t.id 
  	   FROM (SELECT p.id 
  	   		 FROM file_property p 
  	   		 ORDER BY  p.download_times DESC LIMIT 3
  	   		 ) t 
  	  )
  	AND b.status = 0
  </select>
  <select id="queryResource"  parameterType="cn.bnsr.edu_yun.frontstage.resource.view.ResourceView"  resultType="cn.bnsr.edu_yun.frontstage.resource.view.ResourceView" >
  	SELECT b.filename as fileName,b.id as fileId,b.format as format,
  		b.upload_time as uploadTime,c.icon as image,u.username as uploadName,u.icon,
		p.download_times as downloadNum,p.collection_times as collectionNum,
		p.score as score, b.size as size, b.value,b.file_type,b.status
  	FROM file_base b 
	LEFT JOIN user u ON b.upload_user = u.id
	LEFT JOIN file_property p ON p.id = b.property_id
	LEFT JOIN file_catalog c ON c.id = b.catalog_id
	LEFT JOIN teaching_plan tp ON b.teaching_plan_id=tp.id
  	WHERE  (
  	c.classfication_id like CONCAT('%','${sectionId}','%' )  OR
  	tp.lesson like CONCAT('%','${sectionId}','%' )
  	)
  	<if test="file_type!=null">
  	AND file_type=${file_type}
  	</if>
  	<if test="source_type==null">AND b.status = 0</if>
  	<if test="source_type!=null">
  	<if test="status==null">
  	AND b.status != 4 AND b.status != 3
  	</if>
  		<if test="status!=null">
  	AND	 b.status=${status}
  		</if>
  	AND  ((
  	c.range_type=${source_type}
  	AND c.range_id=${source_id}
  	) OR (
  	tp.publish_type=${source_type}
  	AND tp.publish_id=${source_id}
  	))
  	</if>
  	
  	<if test="type != null and type != 0">
    	AND c.type = ${type}
    </if>
    ORDER BY
    <if test="sort == 1">
    	p.collection_times   
    </if>
    <if test="sort == 2">
   		p.download_times  
    </if>
    <if test="sort == 3">
   		b.upload_time 
    </if>
    <if test="sort == 4">
   		p.score  
    </if>
    <if test="sort==0">
    b.upload_time 
    </if>
    DESC
	LIMIT ${startLine},${rows}
  </select>
  <select id="queryTotalResource" parameterType="cn.bnsr.edu_yun.frontstage.resource.view.ResourceView"  resultType="java.lang.Integer" >
  	SELECT count(*)
  	FROM file_base b 
	LEFT JOIN user u ON b.upload_user = u.id
	LEFT JOIN file_property p on p.id = b.property_id
	LEFT JOIN file_catalog c on c.id = b.catalog_id
	LEFT JOIN teaching_plan tp ON b.teaching_plan_id=tp.id
  	WHERE  (
  	c.classfication_id like CONCAT('%','${sectionId}','%' )  OR
  	tp.lesson like CONCAT('%','${sectionId}','%' )
  	)
  	<if test="file_type!=null">
  	AND file_type=${file_type}
  	</if>
   	<if test="source_type==null">AND b.status = 0</if>
  	<if test="source_type!=null">
  	<if test="status==null">
  	AND b.status != 4 AND b.status != 3
  	</if>
  		<if test="status!=null">
  	AND	 b.status=${status}
  		</if>
  	AND ((
  	c.range_type=${source_type}
  	AND c.range_id=${source_id}
  	) OR (
  	tp.publish_type=${source_type}
  	AND tp.publish_id=${source_id}
  	))
  	</if>
 	<if test="type != null and type != 0">
    	AND c.type = ${type}
    </if>
  </select>
  <select id="selectBySearchCount"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id and file_catalog.type!=3 AND file_base.property_id=file_property.id and file_catalog.title like #{str,jdbcType=VARCHAR}
    and file_base.status=0 and file_base.format like #{format,jdbcType=VARCHAR} 
  </select>
  <select id="selectBySearch"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id and file_catalog.type!=3 AND file_base.property_id=file_property.id and file_catalog.title like #{str,jdbcType=VARCHAR} 
    and file_base.status=0 and file_base.format like #{format,jdbcType=VARCHAR} 
     LIMIT  #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  <select id="selectBySearchByTime"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id and file_catalog.type!=3 AND file_base.property_id=file_property.id and file_catalog.title like #{str,jdbcType=VARCHAR}
    and file_base.status=0 and file_base.format like #{format,jdbcType=VARCHAR} 
      ORDER BY file_base.upload_time DESC  LIMIT  #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  <select id="selectBySearchByDownload"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id and file_catalog.type!=3 AND file_base.property_id=file_property.id and file_catalog.title like #{str,jdbcType=VARCHAR} 
    and file_base.status=0 and file_base.format like #{format,jdbcType=VARCHAR} 
     ORDER BY file_property.download_times DESC  LIMIT  #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  <select id="selectBySearchByAgree"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id and file_catalog.type!=3 AND file_base.property_id=file_property.id and file_catalog.title like #{str,jdbcType=VARCHAR}
    and file_base.status=0 and file_base.format like #{format,jdbcType=VARCHAR} 
      ORDER BY file_property.score DESC  LIMIT  #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  
  <select id="find" parameterType="cn.bnsr.edu_yun.backstage.resource.view.BackFileView" resultType="cn.bnsr.edu_yun.backstage.resource.view.BackFileView" >
	SELECT u.username as userName, f.id, f.filename, f.path, f.length,f.size, f.upload_time, f.upload_user, f.status, f.format,f.file_type
    FROM file_base f 
    LEFT JOIN user u ON u.id = upload_user where f.status!=4
    <if test="filename !=null">
      	 <![CDATA[AND f.filename LIKE  '%${filename}%']]>  
    </if>
    <if test="userName != null and userName != ''">
    	<![CDATA[AND u.username LIKE '%${userName}%']]>  
    </if>
    <if test="file_type != null and file_type != ''">
    	AND f.file_type = ${file_type} 
    </if>
     <if test="format != null and format != ''">
    	AND f.format = '${format}' 
    </if>
    <if test="status != null and status != ''">
    	AND f.status = ${status} 
    </if>
    <if test="timeStart != null and timeStart != ''">
   		<![CDATA[ AND f.upload_time >= '${timeStart}']]>  
    </if>
    <if test="timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND f.upload_time <= '${timeEnd}']]>  
    </if>
    <if test="sort !=null and order != null">
    	ORDER BY f.${sort} ${order}
    </if>
    LIMIT ${page},${rows}
  </select>
  
  <select id="count" parameterType="cn.bnsr.edu_yun.backstage.resource.view.BackFileView" resultType="java.lang.Long">
  	SELECT COUNT(*) 
  	FROM file_base f 
  	LEFT JOIN user u ON u.id = upload_user
  	where f.status!=4
  	<if test="filename !=null">
  	 	<![CDATA[AND f.filename LIKE  '%${filename}%']]>  
    </if>
    <if test="userName != null and userName != ''">
    	<![CDATA[AND u.username LIKE '%${userName}%']]>  
    </if>
    <if test="file_type != null and file_type != ''">
    	AND f.file_type = ${file_type} 
    </if>
     <if test="format != null and format != ''">
    	AND f.format = '${format}' 
    </if>
    <if test="status != null and status != ''">
    	AND f.status = ${status} 
    </if>
    <if test="timeStart != null and timeStart != ''">
   		<![CDATA[ AND f.upload_time >= '${timeStart}']]>  
    </if>
    <if test="timeEnd != null and timeEnd !='' ">
      	<![CDATA[ AND f.upload_time <= '${timeEnd}']]>  
    </if>
  </select>
  <select id="queryFileStats" parameterType="cn.bnsr.edu_yun.backstage.resource.view.FileStatsView" resultType="cn.bnsr.edu_yun.backstage.resource.view.FileStatsView">
	SELECT
		<if test="year != '' and month == '' ">
			DATE_FORMAT(f.upload_time,'%Y-%m') days,
		</if>
		<if test="year != '' and month != '' ">
			DATE_FORMAT(f.upload_time,'%Y-%m-%d') days,
		</if>
		<if test="year == '' ">
			DATE_FORMAT(f.upload_time,'%Y-%m-%d') days,
		</if>
		
		count(*) as uploadNum,
		sum(p.download_times) as downLoadNum,sum(p.collection_times) as collectionNum,
		sum(p.click_times) as clickNum
	FROM file_base f
	LEFT JOIN file_property p ON f.property_id = p.id  
	<![CDATA[WHERE f.upload_time LIKE  '%${days}%']]>  
	GROUP BY days;
  	
  </select>
    <select id="selectByBack"  resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 04 09:22:21 CST 2016.
    -->
    SELECT 
    * FROM 
    file_base , file_catalog,file_property,user
    WHERE  file_base.catalog_id=file_catalog.id and file_base.upload_user=user.id  AND file_base.property_id=file_property.id and 
    file_base.status=0 and
    file_catalog.title like #{str,jdbcType=VARCHAR}
    ORDER BY ${sort}  ${order}  LIMIT  #{start,jdbcType=BIGINT},#{pageSize,jdbcType=BIGINT} 
    
  </select>
  
  <select id="getById" resultMap="BaseResultMap">
  	SELECT filename,format,path FROM  file_base  WHERE id = #{id}
  </select>
</mapper>
