<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.bnsr.edu_yun.frontstage.train.mapper.UserStudyTimeMapper">
	<resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="user_id" property="user_id" jdbcType="BIGINT" />
		<result column="course_hour_id" property="course_hour_id" jdbcType="BIGINT" />
		<result column="class_id" property="class_id" jdbcType="BIGINT" />
		<result column="start_time" property="start_time" jdbcType="TIMESTAMP" />
		<result column="study_time" property="study_time" jdbcType="BIGINT" />
		<result column="duration" property="duration" jdbcType="BIGINT" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		id, user_id, course_hour_id, class_id, start_time, study_time, duration
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		select
		<include refid="Base_Column_List" />
		from user_study_time
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		delete from user_study_time
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		<selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into user_study_time (user_id, course_hour_id, class_id,
		start_time, study_time, duration
		)
		values (#{user_id,jdbcType=BIGINT}, #{course_hour_id,jdbcType=BIGINT}, #{class_id,jdbcType=BIGINT},
		#{start_time,jdbcType=TIMESTAMP}, #{study_time,jdbcType=BIGINT}, #{duration,jdbcType=BIGINT}
		)
	</insert>
	<insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		<selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into user_study_time
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="user_id != null">
				user_id,
			</if>
			<if test="course_hour_id != null">
				course_hour_id,
			</if>
			<if test="class_id != null">
				class_id,
			</if>
			<if test="start_time != null">
				start_time,
			</if>
			<if test="study_time != null">
				study_time,
			</if>
			<if test="duration != null">
				duration,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="user_id != null">
				#{user_id,jdbcType=BIGINT},
			</if>
			<if test="course_hour_id != null">
				#{course_hour_id,jdbcType=BIGINT},
			</if>
			<if test="class_id != null">
				#{class_id,jdbcType=BIGINT},
			</if>
			<if test="start_time != null">
				#{start_time,jdbcType=TIMESTAMP},
			</if>
			<if test="study_time != null">
				#{study_time,jdbcType=BIGINT},
			</if>
			<if test="duration != null">
				#{duration,jdbcType=BIGINT},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		update user_study_time
		<set>
			<if test="user_id != null">
				user_id = #{user_id,jdbcType=BIGINT},
			</if>
			<if test="course_hour_id != null">
				course_hour_id = #{course_hour_id,jdbcType=BIGINT},
			</if>
			<if test="class_id != null">
				class_id = #{class_id,jdbcType=BIGINT},
			</if>
			<if test="start_time != null">
				start_time = #{start_time,jdbcType=TIMESTAMP},
			</if>
			<if test="study_time != null">
				study_time = #{study_time,jdbcType=BIGINT},
			</if>
			<if test="duration != null">
				duration = #{duration,jdbcType=BIGINT},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime">
		<!-- WARNING - @mbggenerated This element is automatically generated by MyBatis Generator, do not modify. This element was generated on Thu Sep 07 16:27:02 CST 2017. -->
		update user_study_time
		set user_id = #{user_id,jdbcType=BIGINT},
		course_hour_id = #{course_hour_id,jdbcType=BIGINT},
		class_id = #{class_id,jdbcType=BIGINT},
		start_time = #{start_time,jdbcType=TIMESTAMP},
		study_time = #{study_time,jdbcType=BIGINT},
		duration = #{duration,jdbcType=BIGINT}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<!-- 统计观看数据 -->
	<select id="queryWatchStats" parameterType="cn.bnsr.edu_yun.backstage.train.view.StudyTimeStatsView" resultType="cn.bnsr.edu_yun.backstage.train.view.StudyTimeStatsView">
		SELECT DATE_FORMAT(ust.start_time,
		<if test="timeType != 4">'%Y-%m-%d'</if>
		<if test="timeType == 4">'%H'</if>
		) days,
		COUNT(DISTINCT ust.user_id) AS watchNum,SUM(ust.study_time)/(1000*60
		<if test="timeUnit==2">*60</if>
		) AS totalNum,
		SUM(ust.study_time)/(COUNT(DISTINCT ust.user_id)*1000*60
		<if test="timeUnit==2">*60</if>
		) AS averageNum,
		${timeType} AS timeType
		FROM user_study_time ust
		WHERE 1=1
		<if test="timeType == 0 or timeType == 1 or timeType == 4">
		<![CDATA[AND ust.start_time LIKE  '${days}%']]>
		</if>
		<if test="timeType == 2 or timeType == 3 ">
	 	<![CDATA[ AND ust.start_time >= '${startTime}' AND ust.start_time <= '${endTime}' ]]>
		</if>
		GROUP BY days
	</select>
	<select id="sumTotalUserTime" parameterType="cn.bnsr.edu_yun.frontstage.train.po.UserStudyTime" resultType="java.lang.Long">
		SELECT SUM(study_time) FROM user_study_time WHERE user_id=${user_id}
	</select>
	<select id="selectViewByUserId" parameterType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView" resultType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView">
		SELECT ust.start_time,ust.study_time,ch.hour_title as course_hour_title,
		c.title as course_title
		FROM user_study_time ust
		left join course_hour ch on ust.course_hour_id=ch.id
		left join course c on c.id=ch.course_id
		WHERE ust.user_id=${user_id}
		<if test="class_id!=0">
		and ust.class_id=${class_id}
		</if>
		ORDER BY ust.id DESC
		LIMIT ${page},${rows}
	</select>
	<select id="selectViewByUserIdCount" parameterType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView" resultType="java.lang.Long">
		SELECT count(*) FROM user_study_time ust
		WHERE ust.user_id=${user_id}
		<if test="class_id!=0">
		and ust.class_id=${class_id}
		</if>
	</select>
	<select id="selectSumByUserId" parameterType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView" resultType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView">
		SELECT SUM(ust.study_time)/1000/60 as study_time, DATE_FORMAT(ust.start_time,'%Y-%m-%d') as days
		FROM user_study_time ust
		WHERE ust.user_id=${user_id}
		<if test="days!=null">
	<![CDATA[AND ust.start_time LIKE  '${days}%']]>
		</if>
		<if test="days==null">
			AND ust.start_time BETWEEN '${startTime}' and '${endTime}'
		</if>
		GROUP BY DATE_FORMAT(ust.start_time,'%Y%m%d')
	</select>
	<select id="selectSumByCourseId" parameterType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView" resultType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView">
		SELECT
		<if test="group==2 or group==3"> a.*</if>
		<if test="group==1">
		a.study_time as study_time,SUM(a.user_count) AS user_count,SUM(a.count) AS `count`,SUM(a.study_time)/SUM(a.user_count) AS user_avg,SUM(a.study_time)/SUM(a.count) AS `avg`,a.hours
		</if>
		 FROM (
		SELECT COUNT(DISTINCT ust.user_id) AS user_count,COUNT(*) AS `count`,SUM(ust.study_time) AS study_time,SUM(ust.study_time)/COUNT(DISTINCT ust.user_id) AS user_avg,SUM(ust.study_time)/COUNT(*) AS `avg`,DATE_FORMAT(ust.start_time,'%H') AS hours,DATE_FORMAT(ust.start_time,'%Y-%m-%d') AS days,DATE_FORMAT(ust.start_time,'%U') AS weeks FROM user_study_time ust
		LEFT JOIN course_hour ch ON ch.id=ust.course_hour_id
		LEFT JOIN course c ON c.id=ch.course_id
		WHERE c.id=${course_id}
		<if test="class_id gt 0">
		  AND class_id=${class_id}
		</if>
		<if test="days!=null and days!=''">
	<![CDATA[AND ust.start_time LIKE  '${days}%']]>
		</if>
		<if test="days==null">
			AND ust.start_time BETWEEN '${startTime}' and '${endTime}'
		</if>
		<if test="group==1">
		GROUP BY DATE_FORMAT(ust.start_time,'%Y-%m-%d %H')
		</if>
		<if test="group==2">
		GROUP BY DATE_FORMAT(ust.start_time,'%Y-%m-%d')
		</if>
		<if test="group==3">
		GROUP BY DATE_FORMAT(ust.start_time,'%U')
		</if>
		) a
		<if test="group==1">
		GROUP BY a.hours
		</if>
	</select>
	<select id="selectSumByCourseHour" parameterType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView" resultType="cn.bnsr.edu_yun.backstage.base.view.StudyTimeView">
	SELECT ch.hour_title AS course_hour_title,COUNT(ust.id) AS `count`,SUM(ust.study_time) AS study_time ,ust.id FROM course_hour ch   LEFT JOIN user_study_time ust ON ch.id=ust.course_hour_id LEFT JOIN course c ON c.id=ch.course_id
	 WHERE c.id=${course_id} 
AND ch.hour_type=0
 GROUP BY ch.id ORDER BY `count` DESC 
	</select>
</mapper>