<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bnsr.edu_yun.frontstage.base.mapper.UserDurationPartMapper">
  <resultMap id="BaseResultMap" type="cn.bnsr.edu_yun.frontstage.base.po.UserDurationPart">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="start_time" jdbcType="TIMESTAMP" property="start_time" />
    <result column="end_time" jdbcType="TIMESTAMP" property="end_time" />
    <result column="total_ms" jdbcType="BIGINT" property="total_ms" />
    <result column="user_id" jdbcType="BIGINT" property="user_id" />
    <result column="device" jdbcType="INTEGER" property="device" />
    <result column="province_id" jdbcType="VARCHAR" property="province_id" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="part_id" jdbcType="BIGINT" property="part_id" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    id, start_time, end_time, total_ms, user_id, device, province_id, address, part_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from user_duration_part
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    delete from user_duration_part
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="cn.bnsr.edu_yun.frontstage.base.po.UserDurationPart">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user_duration_part (start_time, end_time, total_ms, 
      user_id, device, province_id, 
      address, part_id)
    values (#{start_time,jdbcType=TIMESTAMP}, #{end_time,jdbcType=TIMESTAMP}, #{total_ms,jdbcType=BIGINT}, 
      #{user_id,jdbcType=BIGINT}, #{device,jdbcType=INTEGER}, #{province_id,jdbcType=VARCHAR}, 
      #{address,jdbcType=VARCHAR}, #{part_id,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.UserDurationPart">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into user_duration_part
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="start_time != null">
        start_time,
      </if>
      <if test="end_time != null">
        end_time,
      </if>
      <if test="total_ms != null">
        total_ms,
      </if>
      <if test="user_id != null">
        user_id,
      </if>
      <if test="device != null">
        device,
      </if>
      <if test="province_id != null">
        province_id,
      </if>
      <if test="address != null">
        address,
      </if>
      <if test="part_id != null">
        part_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="start_time != null">
        #{start_time,jdbcType=TIMESTAMP},
      </if>
      <if test="end_time != null">
        #{end_time,jdbcType=TIMESTAMP},
      </if>
      <if test="total_ms != null">
        #{total_ms,jdbcType=BIGINT},
      </if>
      <if test="user_id != null">
        #{user_id,jdbcType=BIGINT},
      </if>
      <if test="device != null">
        #{device,jdbcType=INTEGER},
      </if>
      <if test="province_id != null">
        #{province_id,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="part_id != null">
        #{part_id,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="cn.bnsr.edu_yun.frontstage.base.po.UserDurationPart">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    update user_duration_part
    <set>
      <if test="start_time != null">
        start_time = #{start_time,jdbcType=TIMESTAMP},
      </if>
      <if test="end_time != null">
        end_time = #{end_time,jdbcType=TIMESTAMP},
      </if>
      <if test="total_ms != null">
        total_ms = #{total_ms,jdbcType=BIGINT},
      </if>
      <if test="user_id != null">
        user_id = #{user_id,jdbcType=BIGINT},
      </if>
      <if test="device != null">
        device = #{device,jdbcType=INTEGER},
      </if>
      <if test="province_id != null">
        province_id = #{province_id,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        address = #{address,jdbcType=VARCHAR},
      </if>
      <if test="part_id != null">
        part_id = #{part_id,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="cn.bnsr.edu_yun.frontstage.base.po.UserDurationPart">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Oct 13 17:04:05 CST 2017.
    -->
    update user_duration_part
    set start_time = #{start_time,jdbcType=TIMESTAMP},
      end_time = #{end_time,jdbcType=TIMESTAMP},
      total_ms = #{total_ms,jdbcType=BIGINT},
      user_id = #{user_id,jdbcType=BIGINT},
      device = #{device,jdbcType=INTEGER},
      province_id = #{province_id,jdbcType=VARCHAR},
      address = #{address,jdbcType=VARCHAR},
      part_id = #{part_id,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <!--ccc  -->
  <select id="queryActiveStats" resultType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView" parameterType="cn.bnsr.edu_yun.backstage.base.view.UserStatsView">
     SELECT x.days,SUM(CASE WHEN x.is_active=1 THEN 1 ELSE 0 END) AS activeNum,SUM(CASE WHEN x.is_active=0 THEN 1 ELSE 0 END) AS tryNum FROM
		(SELECT DATE_FORMAT(ud.end_time,'%Y-%m-%d') AS days,ud.user_id,CASE WHEN SUM(ud.total_ms)-${hour}*60*60*1000>=0 THEN 1 ELSE 0 END AS is_active 
		FROM user_duration_part ud INNER JOIN user_info ui ON ud.user_id = ui.user_id INNER JOIN `user` u ON u.id=ud.user_id
		WHERE 1=1 
		<if  test="sex != 0 ">
			AND ui.sex = ${sex}  
		</if>
		<if test="device != null and device !=-1">
		    AND ud.device = ${device}
		</if>
		<if test="province_id != null and province_id != '' and province_id!='0'.toString()">
		    AND ud.province_id = "${province_id}"
		</if>
		<if test="status == 1">
		    AND TO_DAYS(ud.end_time)=TO_DAYS(u.create_time)
		</if>
		<if test="status == 2">
		    AND TO_DAYS(ud.end_time)!=TO_DAYS(u.create_time)
		</if>
		<if  test="startTime != '' and endTime != '' ">
	 	    <![CDATA[ AND ud.end_time >= '${startTime}' AND ud.end_time < '${endTime}']]>  
		</if>
		<if  test="days != '' ">
			<![CDATA[AND ud.end_time LIKE '${days}%']]>  
		</if>
		GROUP BY days,ud.user_id) x
	 GROUP BY x.days
	 ORDER BY x.days DESC
  
  </select>
</mapper>